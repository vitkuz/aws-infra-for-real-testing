"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_logger_1 = require("@vitkuz/aws-logger");
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
exports.handler = (0, aws_logger_1.withLogger)(async (event, context) => {
    const logger = (0, aws_logger_1.getLogger)();
    if (!logger)
        throw new Error('Logger context missing');
    logger.info('DynamoDB Stream Handler Invoked', {
        data: {
            eventType: 'DynamoDB Trigger',
            recordCount: event.Records.length
        }
    });
    for (const record of event.Records) {
        if (record.eventName === 'INSERT' || record.eventName === 'MODIFY') {
            if (record.dynamodb?.NewImage) {
                // @ts-ignore - DynamoDB Stream types vs Client types mismatch for unmarshall
                const item = (0, util_dynamodb_1.unmarshall)(record.dynamodb.NewImage);
                // Extract x-request-id from item if it exists
                const requestId = item[aws_logger_1.REQUEST_ID_KEY];
                const recordLogger = logger.child(requestId ? { [aws_logger_1.REQUEST_ID_KEY]: requestId } : {});
                recordLogger.info('Processing DynamoDB Record', {
                    data: {
                        eventName: record.eventName,
                        pk: item.pk,
                        item
                    }
                });
            }
        }
        else if (record.eventName === 'REMOVE') {
            if (record.dynamodb?.Keys) {
                // @ts-ignore
                const keys = (0, util_dynamodb_1.unmarshall)(record.dynamodb.Keys);
                logger.info('Processing DynamoDB Deletion', { data: { keys } });
            }
        }
    }
    return { statusCode: 200, body: `Processed ${event.Records.length} records` };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxtREFBMkU7QUFDM0UsMERBQW9EO0FBRXZDLFFBQUEsT0FBTyxHQUFHLElBQUEsdUJBQVUsRUFBQyxLQUFLLEVBQUUsS0FBMEIsRUFBRSxPQUFnQixFQUFFLEVBQUU7SUFDckYsTUFBTSxNQUFNLEdBQUcsSUFBQSxzQkFBUyxHQUFFLENBQUM7SUFDM0IsSUFBSSxDQUFDLE1BQU07UUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUM7SUFFdkQsTUFBTSxDQUFDLElBQUksQ0FBQyxpQ0FBaUMsRUFBRTtRQUMzQyxJQUFJLEVBQUU7WUFDRixTQUFTLEVBQUUsa0JBQWtCO1lBQzdCLFdBQVcsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU07U0FDcEM7S0FDSixDQUFDLENBQUM7SUFFSCxLQUFLLE1BQU0sTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNqQyxJQUFJLE1BQU0sQ0FBQyxTQUFTLEtBQUssUUFBUSxJQUFJLE1BQU0sQ0FBQyxTQUFTLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDakUsSUFBSSxNQUFNLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxDQUFDO2dCQUM1Qiw2RUFBNkU7Z0JBQzdFLE1BQU0sSUFBSSxHQUFHLElBQUEsMEJBQVUsRUFBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQWUsQ0FBQyxDQUFDO2dCQUV6RCw4Q0FBOEM7Z0JBQzlDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQywyQkFBYyxDQUFDLENBQUM7Z0JBQ3ZDLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsMkJBQWMsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFFcEYsWUFBWSxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRTtvQkFDNUMsSUFBSSxFQUFFO3dCQUNGLFNBQVMsRUFBRSxNQUFNLENBQUMsU0FBUzt3QkFDM0IsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFO3dCQUNYLElBQUk7cUJBQ1A7aUJBQ0osQ0FBQyxDQUFDO1lBQ1AsQ0FBQztRQUNMLENBQUM7YUFBTSxJQUFJLE1BQU0sQ0FBQyxTQUFTLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDdkMsSUFBSSxNQUFNLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDO2dCQUN4QixhQUFhO2dCQUNiLE1BQU0sSUFBSSxHQUFHLElBQUEsMEJBQVUsRUFBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQVcsQ0FBQyxDQUFDO2dCQUNyRCxNQUFNLENBQUMsSUFBSSxDQUFDLDhCQUE4QixFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3BFLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxhQUFhLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxVQUFVLEVBQUUsQ0FBQztBQUNsRixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRleHQsIER5bmFtb0RCU3RyZWFtRXZlbnQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IHdpdGhMb2dnZXIsIGdldExvZ2dlciwgUkVRVUVTVF9JRF9LRVkgfSBmcm9tICdAdml0a3V6L2F3cy1sb2dnZXInO1xuaW1wb3J0IHsgdW5tYXJzaGFsbCB9IGZyb20gJ0Bhd3Mtc2RrL3V0aWwtZHluYW1vZGInO1xuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IHdpdGhMb2dnZXIoYXN5bmMgKGV2ZW50OiBEeW5hbW9EQlN0cmVhbUV2ZW50LCBjb250ZXh0OiBDb250ZXh0KSA9PiB7XG4gICAgY29uc3QgbG9nZ2VyID0gZ2V0TG9nZ2VyKCk7XG4gICAgaWYgKCFsb2dnZXIpIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIGNvbnRleHQgbWlzc2luZycpO1xuXG4gICAgbG9nZ2VyLmluZm8oJ0R5bmFtb0RCIFN0cmVhbSBIYW5kbGVyIEludm9rZWQnLCB7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGV2ZW50VHlwZTogJ0R5bmFtb0RCIFRyaWdnZXInLFxuICAgICAgICAgICAgcmVjb3JkQ291bnQ6IGV2ZW50LlJlY29yZHMubGVuZ3RoXG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIGV2ZW50LlJlY29yZHMpIHtcbiAgICAgICAgaWYgKHJlY29yZC5ldmVudE5hbWUgPT09ICdJTlNFUlQnIHx8IHJlY29yZC5ldmVudE5hbWUgPT09ICdNT0RJRlknKSB7XG4gICAgICAgICAgICBpZiAocmVjb3JkLmR5bmFtb2RiPy5OZXdJbWFnZSkge1xuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmUgLSBEeW5hbW9EQiBTdHJlYW0gdHlwZXMgdnMgQ2xpZW50IHR5cGVzIG1pc21hdGNoIGZvciB1bm1hcnNoYWxsXG4gICAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IHVubWFyc2hhbGwocmVjb3JkLmR5bmFtb2RiLk5ld0ltYWdlIGFzIGFueSk7XG5cbiAgICAgICAgICAgICAgICAvLyBFeHRyYWN0IHgtcmVxdWVzdC1pZCBmcm9tIGl0ZW0gaWYgaXQgZXhpc3RzXG4gICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdElkID0gaXRlbVtSRVFVRVNUX0lEX0tFWV07XG4gICAgICAgICAgICAgICAgY29uc3QgcmVjb3JkTG9nZ2VyID0gbG9nZ2VyLmNoaWxkKHJlcXVlc3RJZCA/IHsgW1JFUVVFU1RfSURfS0VZXTogcmVxdWVzdElkIH0gOiB7fSk7XG5cbiAgICAgICAgICAgICAgICByZWNvcmRMb2dnZXIuaW5mbygnUHJvY2Vzc2luZyBEeW5hbW9EQiBSZWNvcmQnLCB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50TmFtZTogcmVjb3JkLmV2ZW50TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBrOiBpdGVtLnBrLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAocmVjb3JkLmV2ZW50TmFtZSA9PT0gJ1JFTU9WRScpIHtcbiAgICAgICAgICAgIGlmIChyZWNvcmQuZHluYW1vZGI/LktleXMpIHtcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgY29uc3Qga2V5cyA9IHVubWFyc2hhbGwocmVjb3JkLmR5bmFtb2RiLktleXMgYXMgYW55KTtcbiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygnUHJvY2Vzc2luZyBEeW5hbW9EQiBEZWxldGlvbicsIHsgZGF0YTogeyBrZXlzIH0gfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGJvZHk6IGBQcm9jZXNzZWQgJHtldmVudC5SZWNvcmRzLmxlbmd0aH0gcmVjb3Jkc2AgfTtcbn0pO1xuIl19