"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_logger_1 = require("@vitkuz/aws-logger");
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
exports.handler = (0, aws_logger_1.withLogger)(async (event, context) => {
    const logger = (0, aws_logger_1.getLogger)();
    if (!logger)
        throw new Error('Logger context missing');
    logger.info('DynamoDB Stream Handler Invoked', {
        eventType: 'DynamoDB Trigger',
        recordCount: event.Records.length
    });
    for (const record of event.Records) {
        if (record.eventName === 'INSERT' || record.eventName === 'MODIFY') {
            if (record.dynamodb?.NewImage) {
                // @ts-ignore - DynamoDB Stream types vs Client types mismatch for unmarshall
                const item = (0, util_dynamodb_1.unmarshall)(record.dynamodb.NewImage);
                // Extract x-request-id from item if it exists
                const requestId = item[aws_logger_1.REQUEST_ID_KEY];
                const recordLogger = logger.child(requestId ? { [aws_logger_1.REQUEST_ID_KEY]: requestId } : {});
                recordLogger.info('Processing DynamoDB Record', {
                    eventName: record.eventName,
                    pk: item.pk,
                    item
                });
            }
        }
        else if (record.eventName === 'REMOVE') {
            if (record.dynamodb?.Keys) {
                // @ts-ignore
                const keys = (0, util_dynamodb_1.unmarshall)(record.dynamodb.Keys);
                logger.info('Processing DynamoDB Deletion', { keys });
            }
        }
    }
    return { statusCode: 200, body: `Processed ${event.Records.length} records` };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHluYW1vLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLG1EQUEyRTtBQUMzRSwwREFBb0Q7QUFFdkMsUUFBQSxPQUFPLEdBQUcsSUFBQSx1QkFBVSxFQUFDLEtBQUssRUFBRSxLQUEwQixFQUFFLE9BQWdCLEVBQUUsRUFBRTtJQUNyRixNQUFNLE1BQU0sR0FBRyxJQUFBLHNCQUFTLEdBQUUsQ0FBQztJQUMzQixJQUFJLENBQUMsTUFBTTtRQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztJQUV2RCxNQUFNLENBQUMsSUFBSSxDQUFDLGlDQUFpQyxFQUFFO1FBQzNDLFNBQVMsRUFBRSxrQkFBa0I7UUFDN0IsV0FBVyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTTtLQUNwQyxDQUFDLENBQUM7SUFFSCxLQUFLLE1BQU0sTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNqQyxJQUFJLE1BQU0sQ0FBQyxTQUFTLEtBQUssUUFBUSxJQUFJLE1BQU0sQ0FBQyxTQUFTLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDakUsSUFBSSxNQUFNLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxDQUFDO2dCQUM1Qiw2RUFBNkU7Z0JBQzdFLE1BQU0sSUFBSSxHQUFHLElBQUEsMEJBQVUsRUFBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQWUsQ0FBQyxDQUFDO2dCQUV6RCw4Q0FBOEM7Z0JBQzlDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQywyQkFBYyxDQUFDLENBQUM7Z0JBQ3ZDLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsMkJBQWMsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFFcEYsWUFBWSxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRTtvQkFDNUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxTQUFTO29CQUMzQixFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUU7b0JBQ1gsSUFBSTtpQkFDUCxDQUFDLENBQUM7WUFDUCxDQUFDO1FBQ0wsQ0FBQzthQUFNLElBQUksTUFBTSxDQUFDLFNBQVMsS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUN2QyxJQUFJLE1BQU0sQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUM7Z0JBQ3hCLGFBQWE7Z0JBQ2IsTUFBTSxJQUFJLEdBQUcsSUFBQSwwQkFBVSxFQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBVyxDQUFDLENBQUM7Z0JBQ3JELE1BQU0sQ0FBQyxJQUFJLENBQUMsOEJBQThCLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQzFELENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxhQUFhLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxVQUFVLEVBQUUsQ0FBQztBQUNsRixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRleHQsIER5bmFtb0RCU3RyZWFtRXZlbnQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IHdpdGhMb2dnZXIsIGdldExvZ2dlciwgUkVRVUVTVF9JRF9LRVkgfSBmcm9tICdAdml0a3V6L2F3cy1sb2dnZXInO1xuaW1wb3J0IHsgdW5tYXJzaGFsbCB9IGZyb20gJ0Bhd3Mtc2RrL3V0aWwtZHluYW1vZGInO1xuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IHdpdGhMb2dnZXIoYXN5bmMgKGV2ZW50OiBEeW5hbW9EQlN0cmVhbUV2ZW50LCBjb250ZXh0OiBDb250ZXh0KSA9PiB7XG4gICAgY29uc3QgbG9nZ2VyID0gZ2V0TG9nZ2VyKCk7XG4gICAgaWYgKCFsb2dnZXIpIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIGNvbnRleHQgbWlzc2luZycpO1xuXG4gICAgbG9nZ2VyLmluZm8oJ0R5bmFtb0RCIFN0cmVhbSBIYW5kbGVyIEludm9rZWQnLCB7XG4gICAgICAgIGV2ZW50VHlwZTogJ0R5bmFtb0RCIFRyaWdnZXInLFxuICAgICAgICByZWNvcmRDb3VudDogZXZlbnQuUmVjb3Jkcy5sZW5ndGhcbiAgICB9KTtcblxuICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIGV2ZW50LlJlY29yZHMpIHtcbiAgICAgICAgaWYgKHJlY29yZC5ldmVudE5hbWUgPT09ICdJTlNFUlQnIHx8IHJlY29yZC5ldmVudE5hbWUgPT09ICdNT0RJRlknKSB7XG4gICAgICAgICAgICBpZiAocmVjb3JkLmR5bmFtb2RiPy5OZXdJbWFnZSkge1xuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmUgLSBEeW5hbW9EQiBTdHJlYW0gdHlwZXMgdnMgQ2xpZW50IHR5cGVzIG1pc21hdGNoIGZvciB1bm1hcnNoYWxsXG4gICAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IHVubWFyc2hhbGwocmVjb3JkLmR5bmFtb2RiLk5ld0ltYWdlIGFzIGFueSk7XG5cbiAgICAgICAgICAgICAgICAvLyBFeHRyYWN0IHgtcmVxdWVzdC1pZCBmcm9tIGl0ZW0gaWYgaXQgZXhpc3RzXG4gICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdElkID0gaXRlbVtSRVFVRVNUX0lEX0tFWV07XG4gICAgICAgICAgICAgICAgY29uc3QgcmVjb3JkTG9nZ2VyID0gbG9nZ2VyLmNoaWxkKHJlcXVlc3RJZCA/IHsgW1JFUVVFU1RfSURfS0VZXTogcmVxdWVzdElkIH0gOiB7fSk7XG5cbiAgICAgICAgICAgICAgICByZWNvcmRMb2dnZXIuaW5mbygnUHJvY2Vzc2luZyBEeW5hbW9EQiBSZWNvcmQnLCB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50TmFtZTogcmVjb3JkLmV2ZW50TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgcGs6IGl0ZW0ucGssXG4gICAgICAgICAgICAgICAgICAgIGl0ZW1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChyZWNvcmQuZXZlbnROYW1lID09PSAnUkVNT1ZFJykge1xuICAgICAgICAgICAgaWYgKHJlY29yZC5keW5hbW9kYj8uS2V5cykge1xuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICBjb25zdCBrZXlzID0gdW5tYXJzaGFsbChyZWNvcmQuZHluYW1vZGIuS2V5cyBhcyBhbnkpO1xuICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCdQcm9jZXNzaW5nIER5bmFtb0RCIERlbGV0aW9uJywgeyBrZXlzIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBib2R5OiBgUHJvY2Vzc2VkICR7ZXZlbnQuUmVjb3Jkcy5sZW5ndGh9IHJlY29yZHNgIH07XG59KTtcbiJdfQ==