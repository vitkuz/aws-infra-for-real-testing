"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_logger_1 = require("@vitkuz/aws-logger");
const aws_s3_adapter_1 = require("@vitkuz/aws-s3-adapter");
const client = (0, aws_s3_adapter_1.createS3Client)({});
exports.handler = (0, aws_logger_1.withLogger)(async (event, context) => {
    // const bucketName = process.env.BUCKET_NAME; // Unused
    const logger = (0, aws_logger_1.getLogger)();
    const ctx = { logger, client };
    if (!logger)
        throw new Error('Logger context missing');
    logger.info('S3 Handler Invoked', { data: { eventType: 'S3 Trigger', recordCount: event.Records.length } });
    for (const record of event.Records) {
        const bucket = record.s3.bucket.name;
        const key = decodeURIComponent(record.s3.object.key.replace(/\+/g, ' '));
        try {
            // Fetch metadata to look for x-request-id
            const headOutput = await (0, aws_s3_adapter_1.headObject)(ctx)({
                Bucket: bucket,
                Key: key
            });
            const requestId = headOutput.Metadata?.[aws_logger_1.REQUEST_ID_KEY];
            const recordLogger = logger.child(requestId ? { [aws_logger_1.REQUEST_ID_KEY]: requestId } : {});
            recordLogger.info('Processing S3 Record', {
                data: {
                    bucket,
                    key,
                    size: record.s3.object.size,
                    eventName: record.eventName
                }
            });
        }
        catch (error) {
            logger.error('Error processing S3 record', { error: error, data: { bucket, key } });
        }
    }
    return { statusCode: 200, body: `Processed ${event.Records.length} records` };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxtREFBMkU7QUFDM0UsMkRBQW9FO0FBRXBFLE1BQU0sTUFBTSxHQUFHLElBQUEsK0JBQWMsRUFBQyxFQUFFLENBQUMsQ0FBQztBQUVyQixRQUFBLE9BQU8sR0FBRyxJQUFBLHVCQUFVLEVBQUMsS0FBSyxFQUFFLEtBQWMsRUFBRSxPQUFnQixFQUFFLEVBQUU7SUFDekUsd0RBQXdEO0lBQ3hELE1BQU0sTUFBTSxHQUFHLElBQUEsc0JBQVMsR0FBRSxDQUFDO0lBQzNCLE1BQU0sR0FBRyxHQUFHLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDO0lBRS9CLElBQUksQ0FBQyxNQUFNO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0lBRXZELE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztJQUU1RyxLQUFLLE1BQU0sTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNqQyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDckMsTUFBTSxHQUFHLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUV6RSxJQUFJLENBQUM7WUFDRCwwQ0FBMEM7WUFDMUMsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFBLDJCQUFVLEVBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3JDLE1BQU0sRUFBRSxNQUFNO2dCQUNkLEdBQUcsRUFBRSxHQUFHO2FBQ1gsQ0FBQyxDQUFDO1lBRUgsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDLDJCQUFjLENBQUMsQ0FBQztZQUN4RCxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLDJCQUFjLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFcEYsWUFBWSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBRTtnQkFDdEMsSUFBSSxFQUFFO29CQUNGLE1BQU07b0JBQ04sR0FBRztvQkFDSCxJQUFJLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSTtvQkFDM0IsU0FBUyxFQUFFLE1BQU0sQ0FBQyxTQUFTO2lCQUM5QjthQUNKLENBQUMsQ0FBQztRQUVQLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2IsTUFBTSxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsRUFBRSxFQUFFLEtBQUssRUFBRSxLQUFjLEVBQUUsSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxFQUFTLENBQUMsQ0FBQztRQUN4RyxDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxhQUFhLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxVQUFVLEVBQUUsQ0FBQztBQUNsRixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRleHQsIFMzRXZlbnQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IHdpdGhMb2dnZXIsIGdldExvZ2dlciwgUkVRVUVTVF9JRF9LRVkgfSBmcm9tICdAdml0a3V6L2F3cy1sb2dnZXInO1xuaW1wb3J0IHsgY3JlYXRlUzNDbGllbnQsIGhlYWRPYmplY3QgfSBmcm9tICdAdml0a3V6L2F3cy1zMy1hZGFwdGVyJztcblxuY29uc3QgY2xpZW50ID0gY3JlYXRlUzNDbGllbnQoe30pO1xuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IHdpdGhMb2dnZXIoYXN5bmMgKGV2ZW50OiBTM0V2ZW50LCBjb250ZXh0OiBDb250ZXh0KSA9PiB7XG4gICAgLy8gY29uc3QgYnVja2V0TmFtZSA9IHByb2Nlc3MuZW52LkJVQ0tFVF9OQU1FOyAvLyBVbnVzZWRcbiAgICBjb25zdCBsb2dnZXIgPSBnZXRMb2dnZXIoKTtcbiAgICBjb25zdCBjdHggPSB7IGxvZ2dlciwgY2xpZW50IH07XG5cbiAgICBpZiAoIWxvZ2dlcikgdGhyb3cgbmV3IEVycm9yKCdMb2dnZXIgY29udGV4dCBtaXNzaW5nJyk7XG5cbiAgICBsb2dnZXIuaW5mbygnUzMgSGFuZGxlciBJbnZva2VkJywgeyBkYXRhOiB7IGV2ZW50VHlwZTogJ1MzIFRyaWdnZXInLCByZWNvcmRDb3VudDogZXZlbnQuUmVjb3Jkcy5sZW5ndGggfSB9KTtcblxuICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIGV2ZW50LlJlY29yZHMpIHtcbiAgICAgICAgY29uc3QgYnVja2V0ID0gcmVjb3JkLnMzLmJ1Y2tldC5uYW1lO1xuICAgICAgICBjb25zdCBrZXkgPSBkZWNvZGVVUklDb21wb25lbnQocmVjb3JkLnMzLm9iamVjdC5rZXkucmVwbGFjZSgvXFwrL2csICcgJykpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBGZXRjaCBtZXRhZGF0YSB0byBsb29rIGZvciB4LXJlcXVlc3QtaWRcbiAgICAgICAgICAgIGNvbnN0IGhlYWRPdXRwdXQgPSBhd2FpdCBoZWFkT2JqZWN0KGN0eCkoe1xuICAgICAgICAgICAgICAgIEJ1Y2tldDogYnVja2V0LFxuICAgICAgICAgICAgICAgIEtleToga2V5XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY29uc3QgcmVxdWVzdElkID0gaGVhZE91dHB1dC5NZXRhZGF0YT8uW1JFUVVFU1RfSURfS0VZXTtcbiAgICAgICAgICAgIGNvbnN0IHJlY29yZExvZ2dlciA9IGxvZ2dlci5jaGlsZChyZXF1ZXN0SWQgPyB7IFtSRVFVRVNUX0lEX0tFWV06IHJlcXVlc3RJZCB9IDoge30pO1xuXG4gICAgICAgICAgICByZWNvcmRMb2dnZXIuaW5mbygnUHJvY2Vzc2luZyBTMyBSZWNvcmQnLCB7XG4gICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICBidWNrZXQsXG4gICAgICAgICAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgICAgICAgICAgc2l6ZTogcmVjb3JkLnMzLm9iamVjdC5zaXplLFxuICAgICAgICAgICAgICAgICAgICBldmVudE5hbWU6IHJlY29yZC5ldmVudE5hbWVcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBwcm9jZXNzaW5nIFMzIHJlY29yZCcsIHsgZXJyb3I6IGVycm9yIGFzIEVycm9yLCBkYXRhOiB7IGJ1Y2tldCwga2V5IH0gfSBhcyBhbnkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBib2R5OiBgUHJvY2Vzc2VkICR7ZXZlbnQuUmVjb3Jkcy5sZW5ndGh9IHJlY29yZHNgIH07XG59KTtcbiJdfQ==