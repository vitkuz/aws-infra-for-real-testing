"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_logger_1 = require("@vitkuz/aws-logger");
const aws_s3_adapter_1 = require("@vitkuz/aws-s3-adapter");
const client = (0, aws_s3_adapter_1.createS3Client)({});
exports.handler = (0, aws_logger_1.withLogger)(async (event, context) => {
    // const bucketName = process.env.BUCKET_NAME; // Unused
    const logger = (0, aws_logger_1.getLogger)();
    const ctx = { logger, client };
    if (!logger)
        throw new Error('Logger context missing');
    logger.info('S3 Handler Invoked', { eventType: 'S3 Trigger', recordCount: event.Records.length });
    for (const record of event.Records) {
        const bucket = record.s3.bucket.name;
        const key = decodeURIComponent(record.s3.object.key.replace(/\+/g, ' '));
        try {
            // Fetch metadata to look for x-request-id
            const headOutput = await (0, aws_s3_adapter_1.headObject)(ctx)({
                Bucket: bucket,
                Key: key
            });
            const requestId = headOutput.Metadata?.[aws_logger_1.REQUEST_ID_KEY];
            const recordLogger = logger.child(requestId ? { [aws_logger_1.REQUEST_ID_KEY]: requestId } : {});
            recordLogger.info('Processing S3 Record', {
                bucket,
                key,
                size: record.s3.object.size,
                eventName: record.eventName
            });
        }
        catch (error) {
            logger.error('Error processing S3 record', error, { bucket, key });
        }
    }
    return { statusCode: 200, body: `Processed ${event.Records.length} records` };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiczMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzMy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxtREFBMkU7QUFDM0UsMkRBQW9FO0FBRXBFLE1BQU0sTUFBTSxHQUFHLElBQUEsK0JBQWMsRUFBQyxFQUFFLENBQUMsQ0FBQztBQUVyQixRQUFBLE9BQU8sR0FBRyxJQUFBLHVCQUFVLEVBQUMsS0FBSyxFQUFFLEtBQWMsRUFBRSxPQUFnQixFQUFFLEVBQUU7SUFDekUsd0RBQXdEO0lBQ3hELE1BQU0sTUFBTSxHQUFHLElBQUEsc0JBQVMsR0FBRSxDQUFDO0lBQzNCLE1BQU0sR0FBRyxHQUFHLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDO0lBRS9CLElBQUksQ0FBQyxNQUFNO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0lBRXZELE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFFbEcsS0FBSyxNQUFNLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDakMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ3JDLE1BQU0sR0FBRyxHQUFHLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFekUsSUFBSSxDQUFDO1lBQ0QsMENBQTBDO1lBQzFDLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBQSwyQkFBVSxFQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNyQyxNQUFNLEVBQUUsTUFBTTtnQkFDZCxHQUFHLEVBQUUsR0FBRzthQUNYLENBQUMsQ0FBQztZQUVILE1BQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQyxRQUFRLEVBQUUsQ0FBQywyQkFBYyxDQUFDLENBQUM7WUFDeEQsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQywyQkFBYyxDQUFDLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXBGLFlBQVksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLEVBQUU7Z0JBQ3RDLE1BQU07Z0JBQ04sR0FBRztnQkFDSCxJQUFJLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSTtnQkFDM0IsU0FBUyxFQUFFLE1BQU0sQ0FBQyxTQUFTO2FBQzlCLENBQUMsQ0FBQztRQUVQLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2IsTUFBTSxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsRUFBRSxLQUFjLEVBQUUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNoRixDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxhQUFhLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxVQUFVLEVBQUUsQ0FBQztBQUNsRixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRleHQsIFMzRXZlbnQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IHdpdGhMb2dnZXIsIGdldExvZ2dlciwgUkVRVUVTVF9JRF9LRVkgfSBmcm9tICdAdml0a3V6L2F3cy1sb2dnZXInO1xuaW1wb3J0IHsgY3JlYXRlUzNDbGllbnQsIGhlYWRPYmplY3QgfSBmcm9tICdAdml0a3V6L2F3cy1zMy1hZGFwdGVyJztcblxuY29uc3QgY2xpZW50ID0gY3JlYXRlUzNDbGllbnQoe30pO1xuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IHdpdGhMb2dnZXIoYXN5bmMgKGV2ZW50OiBTM0V2ZW50LCBjb250ZXh0OiBDb250ZXh0KSA9PiB7XG4gICAgLy8gY29uc3QgYnVja2V0TmFtZSA9IHByb2Nlc3MuZW52LkJVQ0tFVF9OQU1FOyAvLyBVbnVzZWRcbiAgICBjb25zdCBsb2dnZXIgPSBnZXRMb2dnZXIoKTtcbiAgICBjb25zdCBjdHggPSB7IGxvZ2dlciwgY2xpZW50IH07XG5cbiAgICBpZiAoIWxvZ2dlcikgdGhyb3cgbmV3IEVycm9yKCdMb2dnZXIgY29udGV4dCBtaXNzaW5nJyk7XG5cbiAgICBsb2dnZXIuaW5mbygnUzMgSGFuZGxlciBJbnZva2VkJywgeyBldmVudFR5cGU6ICdTMyBUcmlnZ2VyJywgcmVjb3JkQ291bnQ6IGV2ZW50LlJlY29yZHMubGVuZ3RoIH0pO1xuXG4gICAgZm9yIChjb25zdCByZWNvcmQgb2YgZXZlbnQuUmVjb3Jkcykge1xuICAgICAgICBjb25zdCBidWNrZXQgPSByZWNvcmQuczMuYnVja2V0Lm5hbWU7XG4gICAgICAgIGNvbnN0IGtleSA9IGRlY29kZVVSSUNvbXBvbmVudChyZWNvcmQuczMub2JqZWN0LmtleS5yZXBsYWNlKC9cXCsvZywgJyAnKSk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIEZldGNoIG1ldGFkYXRhIHRvIGxvb2sgZm9yIHgtcmVxdWVzdC1pZFxuICAgICAgICAgICAgY29uc3QgaGVhZE91dHB1dCA9IGF3YWl0IGhlYWRPYmplY3QoY3R4KSh7XG4gICAgICAgICAgICAgICAgQnVja2V0OiBidWNrZXQsXG4gICAgICAgICAgICAgICAgS2V5OiBrZXlcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0SWQgPSBoZWFkT3V0cHV0Lk1ldGFkYXRhPy5bUkVRVUVTVF9JRF9LRVldO1xuICAgICAgICAgICAgY29uc3QgcmVjb3JkTG9nZ2VyID0gbG9nZ2VyLmNoaWxkKHJlcXVlc3RJZCA/IHsgW1JFUVVFU1RfSURfS0VZXTogcmVxdWVzdElkIH0gOiB7fSk7XG5cbiAgICAgICAgICAgIHJlY29yZExvZ2dlci5pbmZvKCdQcm9jZXNzaW5nIFMzIFJlY29yZCcsIHtcbiAgICAgICAgICAgICAgICBidWNrZXQsXG4gICAgICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgICAgIHNpemU6IHJlY29yZC5zMy5vYmplY3Quc2l6ZSxcbiAgICAgICAgICAgICAgICBldmVudE5hbWU6IHJlY29yZC5ldmVudE5hbWVcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHByb2Nlc3NpbmcgUzMgcmVjb3JkJywgZXJyb3IgYXMgRXJyb3IsIHsgYnVja2V0LCBrZXkgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGJvZHk6IGBQcm9jZXNzZWQgJHtldmVudC5SZWNvcmRzLmxlbmd0aH0gcmVjb3Jkc2AgfTtcbn0pO1xuIl19