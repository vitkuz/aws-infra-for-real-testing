"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_logger_1 = require("@vitkuz/aws-logger");
const opensearch_1 = require("@opensearch-project/opensearch");
const aws_opensearch_adapter_1 = require("@vitkuz/aws-opensearch-adapter");
const aws_dynamo_adapter_1 = require("@vitkuz/aws-dynamo-adapter");
const credential_provider_node_1 = require("@aws-sdk/credential-provider-node");
const aws_1 = require("@opensearch-project/opensearch/aws");
const OPENSEARCH_ENDPOINT = process.env.OPENSEARCH_ENDPOINT;
const TABLE_NAME = process.env.TABLE_NAME;
const REGION = process.env.AWS_REGION;
if (!OPENSEARCH_ENDPOINT || !TABLE_NAME || !REGION) {
    throw new Error('Missing environment variables');
}
const osClient = new opensearch_1.Client({
    ...(0, aws_1.AwsSigv4Signer)({
        region: REGION,
        service: 'es',
        getCredentials: () => (0, credential_provider_node_1.defaultProvider)()(),
    }),
    node: `https://${OPENSEARCH_ENDPOINT}` // Node must come after signer to work correctly with some versions, but standard spread works
});
const dynamoClientConfig = { region: REGION };
exports.handler = (0, aws_logger_1.withLogger)(async (event, context) => {
    const logger = (0, aws_logger_1.getLogger)();
    if (!logger)
        throw new Error('Logger missing');
    const headers = event.headers || {};
    // Extract request ID using custom key or keys from header
    const requestId = headers['x-request-id'] || headers['X-Request-Id'];
    // Create a child logger with the request ID
    const childLogger = logger.child(requestId ? { [aws_logger_1.REQUEST_ID_KEY]: requestId } : {});
    // Initialize adapters with the child logger
    const osAdapter = (0, aws_opensearch_adapter_1.createAdapter)({ client: osClient, logger: childLogger });
    const dynamoAdapter = (0, aws_dynamo_adapter_1.createAdapter)(dynamoClientConfig, childLogger);
    const { path, httpMethod, body } = event;
    const jsonBody = body ? JSON.parse(body) : {};
    childLogger.info('Search Sync API Request', { data: { path, httpMethod, requestId } });
    try {
        // --- OpenSearch Routes ---
        // POST /search -> Match Query
        if (path === '/search' && httpMethod === 'POST') {
            const { index, query } = jsonBody;
            // Using raw client for search as adapter likely lacks it (based on previous check)
            // Ideally we'd extend the adapter, but for now we use the client directly but log with our logger
            const result = await osClient.search({
                index,
                body: {
                    query: {
                        match: query
                    }
                }
            });
            return json(200, result.body);
        }
        // POST /indices -> Create Index
        if (path === '/indices' && httpMethod === 'POST') {
            const { index } = jsonBody;
            await osAdapter.createIndex({ index });
            return json(201, { message: `Index ${index} created` });
        }
        // DELETE /indices/{name} -> Delete Index
        if (path.startsWith('/indices/') && httpMethod === 'DELETE') {
            const index = path.split('/')[2];
            await osAdapter.deleteIndex({ index });
            return json(200, { message: `Index ${index} deleted` });
        }
        // PUT /indices/{name}/mapping -> Update Mapping
        if (path.startsWith('/indices/') && path.endsWith('/mapping') && httpMethod === 'PUT') {
            const index = path.split('/')[2];
            const { properties } = jsonBody;
            await osAdapter.updateMapping({
                index,
                body: { properties }
            });
            return json(200, { message: `Mapping updated for ${index}` });
        }
        // GET /indices/{name}/mapping -> Get Mapping
        if (path.startsWith('/indices/') && path.endsWith('/mapping') && httpMethod === 'GET') {
            const index = path.split('/')[2];
            const mapping = await osAdapter.getMapping({ index });
            return json(200, mapping);
        }
        // GET /indices/{name}/documents/{id} -> Get Document
        if (path.startsWith('/indices/') && path.includes('/documents/') && httpMethod === 'GET') {
            const parts = path.split('/');
            // /indices/{index}/documents/{id} -> ['', 'indices', 'indexName', 'documents', 'id']
            const index = parts[2];
            const id = parts[4];
            try {
                const doc = await osAdapter.getDocument({ index, id });
                return json(200, doc);
            }
            catch (error) {
                if (error.meta && error.meta.statusCode === 404) {
                    return json(404, { message: 'Document not found' });
                }
                throw error;
            }
        }
        // --- DynamoDB Routes ---
        // POST /records -> Add Record
        if (path === '/records' && httpMethod === 'POST') {
            const { item } = jsonBody;
            // Adapter requires 'id' and 'pk' (and 'sk').
            // If incoming item implies pk IS the id, ensure id is set.
            // Also, 'createOne' enforces id === pk if both exist.
            if (item.pk && !item.id) {
                item.id = item.pk;
            }
            if (!item.sk) {
                // Fallback if not provided, though test currently provides it
                item.sk = 'metadata';
            }
            await dynamoAdapter.createOne({
                tableName: TABLE_NAME,
                item: item
            });
            return json(201, { message: 'Record created', item });
        }
        // DELETE /records/{id} -> Remove Record
        if (path.startsWith('/records/') && httpMethod === 'DELETE') {
            const id = path.split('/')[2];
            // Adapter 'deleteOne' input: { tableName, item: { pk, sk } }
            await dynamoAdapter.deleteOne({
                tableName: TABLE_NAME,
                item: { pk: id, sk: 'metadata' } // Assuming sk is 'metadata' based on convention/test
            });
            return json(200, { message: `Record ${id} deleted` });
        }
        // PATCH /records/{id} -> Patch Record
        if (path.startsWith('/records/') && httpMethod === 'PATCH') {
            const id = path.split('/')[2];
            const { attributes } = jsonBody;
            // Adapter 'patchOne' input: { tableName, item: { pk, sk, ...attributes } }
            const patchItem = {
                pk: id,
                sk: 'metadata',
                ...attributes
            };
            const result = await dynamoAdapter.patchOne({
                tableName: TABLE_NAME,
                item: patchItem
            });
            return json(200, { message: `Record ${id} patched`, result });
        }
        return json(404, { message: 'Route not found' });
    }
    catch (error) {
        childLogger.error('API Error', { error: error instanceof Error ? error : String(error) });
        return json(500, { error: error instanceof Error ? error.message : 'Internal Server Error' });
    }
});
const json = (statusCode, body) => ({
    statusCode,
    body: JSON.stringify(body),
    headers: { 'Content-Type': 'application/json' }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxtREFBMkU7QUFDM0UsK0RBQXdEO0FBQ3hELDJFQUFrRjtBQUNsRixtRUFBa0Y7QUFDbEYsZ0ZBQW9FO0FBQ3BFLDREQUFvRTtBQUVwRSxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUM7QUFDNUQsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7QUFDMUMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7QUFFdEMsSUFBSSxDQUFDLG1CQUFtQixJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDakQsTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0FBQ3JELENBQUM7QUFFRCxNQUFNLFFBQVEsR0FBRyxJQUFJLG1CQUFNLENBQUM7SUFDeEIsR0FBRyxJQUFBLG9CQUFjLEVBQUM7UUFDZCxNQUFNLEVBQUUsTUFBTTtRQUNkLE9BQU8sRUFBRSxJQUFJO1FBQ2IsY0FBYyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUEsMENBQWUsR0FBRSxFQUFFO0tBQzVDLENBQUM7SUFDRixJQUFJLEVBQUUsV0FBVyxtQkFBbUIsRUFBRSxDQUFDLDhGQUE4RjtDQUN4SSxDQUFDLENBQUM7QUFFSCxNQUFNLGtCQUFrQixHQUFHLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDO0FBRWpDLFFBQUEsT0FBTyxHQUFHLElBQUEsdUJBQVUsRUFBQyxLQUFLLEVBQUUsS0FBMkIsRUFBRSxPQUFnQixFQUFFLEVBQUU7SUFDdEYsTUFBTSxNQUFNLEdBQUcsSUFBQSxzQkFBUyxHQUFFLENBQUM7SUFDM0IsSUFBSSxDQUFDLE1BQU07UUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENB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RSxFQUFFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxDQUFDLENBQUM7SUFFckQsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDYixXQUFXLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxFQUFFLEtBQUssRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBUyxDQUFDLENBQUM7UUFDakcsT0FBTyxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLHVCQUF1QixFQUFFLENBQUMsQ0FBQztJQUNsRyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLElBQUksR0FBRyxDQUFDLFVBQWtCLEVBQUUsSUFBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdDLFVBQVU7SUFDVixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7SUFDMUIsT0FBTyxFQUFFLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFO0NBQ2xELENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyB3aXRoTG9nZ2VyLCBnZXRMb2dnZXIsIFJFUVVFU1RfSURfS0VZIH0gZnJvbSAnQHZpdGt1ei9hd3MtbG9nZ2VyJztcbmltcG9ydCB7IENsaWVudCB9IGZyb20gJ0BvcGVuc2VhcmNoLXByb2plY3Qvb3BlbnNlYXJjaCc7XG5pbXBvcnQgeyBjcmVhdGVBZGFwdGVyIGFzIGNyZWF0ZU9zQWRhcHRlciB9IGZyb20gJ0B2aXRrdXovYXdzLW9wZW5zZWFyY2gtYWRhcHRlcic7XG5pbXBvcnQgeyBjcmVhdGVBZGFwdGVyIGFzIGNyZWF0ZUR5bmFtb0FkYXB0ZXIgfSBmcm9tICdAdml0a3V6L2F3cy1keW5hbW8tYWRhcHRlcic7XG5pbXBvcnQgeyBkZWZhdWx0UHJvdmlkZXIgfSBmcm9tICdAYXdzLXNkay9jcmVkZW50aWFsLXByb3ZpZGVyLW5vZGUnO1xuaW1wb3J0IHsgQXdzU2lndjRTaWduZXIgfSBmcm9tICdAb3BlbnNlYXJjaC1wcm9qZWN0L29wZW5zZWFyY2gvYXdzJztcblxuY29uc3QgT1BFTlNFQVJDSF9FTkRQT0lOVCA9IHByb2Nlc3MuZW52Lk9QRU5TRUFSQ0hfRU5EUE9JTlQ7XG5jb25zdCBUQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuVEFCTEVfTkFNRTtcbmNvbnN0IFJFR0lPTiA9IHByb2Nlc3MuZW52LkFXU19SRUdJT047XG5cbmlmICghT1BFTlNFQVJDSF9FTkRQT0lOVCB8fCAhVEFCTEVfTkFNRSB8fCAhUkVHSU9OKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIGVudmlyb25tZW50IHZhcmlhYmxlcycpO1xufVxuXG5jb25zdCBvc0NsaWVudCA9IG5ldyBDbGllbnQoe1xuICAgIC4uLkF3c1NpZ3Y0U2lnbmVyKHtcbiAgICAgICAgcmVnaW9uOiBSRUdJT04sXG4gICAgICAgIHNlcnZpY2U6ICdlcycsXG4gICAgICAgIGdldENyZWRlbnRpYWxzOiAoKSA9PiBkZWZhdWx0UHJvdmlkZXIoKSgpLFxuICAgIH0pLFxuICAgIG5vZGU6IGBodHRwczovLyR7T1BFTlNFQVJDSF9FTkRQT0lOVH1gIC8vIE5vZGUgbXVzdCBjb21lIGFmdGVyIHNpZ25lciB0byB3b3JrIGNvcnJlY3RseSB3aXRoIHNvbWUgdmVyc2lvbnMsIGJ1dCBzdGFuZGFyZCBzcHJlYWQgd29ya3Ncbn0pO1xuXG5jb25zdCBkeW5hbW9DbGllbnRDb25maWcgPSB7IHJlZ2lvbjogUkVHSU9OIH07XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gd2l0aExvZ2dlcihhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBjb250ZXh0OiBDb250ZXh0KSA9PiB7XG4gICAgY29uc3QgbG9nZ2VyID0gZ2V0TG9nZ2VyKCk7XG4gICAgaWYgKCFsb2dnZXIpIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIG1pc3NpbmcnKTtcblxuICAgIGNvbnN0IGhlYWRlcnMgPSBldmVudC5oZWFkZXJzIHx8IHt9O1xuICAgIC8vIEV4dHJhY3QgcmVxdWVzdCBJRCB1c2luZyBjdXN0b20ga2V5IG9yIGtleXMgZnJvbSBoZWFkZXJcbiAgICBjb25zdCByZXF1ZXN0SWQgPSBoZWFkZXJzWyd4LXJlcXVlc3QtaWQnXSB8fCBoZWFkZXJzWydYLVJlcXVlc3QtSWQnXTtcblxuICAgIC8vIENyZWF0ZSBhIGNoaWxkIGxvZ2dlciB3aXRoIHRoZSByZXF1ZXN0IElEXG4gICAgY29uc3QgY2hpbGRMb2dnZXIgPSBsb2dnZXIuY2hpbGQocmVxdWVzdElkID8geyBbUkVRVUVTVF9JRF9LRVldOiByZXF1ZXN0SWQgfSA6IHt9KTtcblxuICAgIC8vIEluaXRpYWxpemUgYWRhcHRlcnMgd2l0aCB0aGUgY2hpbGQgbG9nZ2VyXG4gICAgY29uc3Qgb3NBZGFwdGVyID0gY3JlYXRlT3NBZGFwdGVyKHsgY2xpZW50OiBvc0NsaWVudCwgbG9nZ2VyOiBjaGlsZExvZ2dlciB9KTtcbiAgICBjb25zdCBkeW5hbW9BZGFwdGVyID0gY3JlYXRlRHluYW1vQWRhcHRlcihkeW5hbW9DbGllbnRDb25maWcsIGNoaWxkTG9nZ2VyKTtcblxuICAgIGNvbnN0IHsgcGF0aCwgaHR0cE1ldGhvZCwgYm9keSB9ID0gZXZlbnQ7XG4gICAgY29uc3QganNvbkJvZHkgPSBib2R5ID8gSlNPTi5wYXJzZShib2R5KSA6IHt9O1xuXG4gICAgY2hpbGRMb2dnZXIuaW5mbygnU2VhcmNoIFN5bmMgQVBJIFJlcXVlc3QnLCB7IGRhdGE6IHsgcGF0aCwgaHR0cE1ldGhvZCwgcmVxdWVzdElkIH0gfSk7XG5cbiAgICB0cnkge1xuICAgICAgICAvLyAtLS0gT3BlblNlYXJjaCBSb3V0ZXMgLS0tXG5cbiAgICAgICAgLy8gUE9TVCAvc2VhcmNoIC0+IE1hdGNoIFF1ZXJ5XG4gICAgICAgIGlmIChwYXRoID09PSAnL3NlYXJjaCcgJiYgaHR0cE1ldGhvZCA9PT0gJ1BPU1QnKSB7XG4gICAgICAgICAgICBjb25zdCB7IGluZGV4LCBxdWVyeSB9ID0ganNvbkJvZHk7XG4gICAgICAgICAgICAvLyBVc2luZyByYXcgY2xpZW50IGZvciBzZWFyY2ggYXMgYWRhcHRlciBsaWtlbHkgbGFja3MgaXQgKGJhc2VkIG9uIHByZXZpb3VzIGNoZWNrKVxuICAgICAgICAgICAgLy8gSWRlYWxseSB3ZSdkIGV4dGVuZCB0aGUgYWRhcHRlciwgYnV0IGZvciBub3cgd2UgdXNlIHRoZSBjbGllbnQgZGlyZWN0bHkgYnV0IGxvZyB3aXRoIG91ciBsb2dnZXJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG9zQ2xpZW50LnNlYXJjaCh7XG4gICAgICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICAgICAgYm9keToge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeToge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2g6IHF1ZXJ5XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBqc29uKDIwMCwgcmVzdWx0LmJvZHkpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gUE9TVCAvaW5kaWNlcyAtPiBDcmVhdGUgSW5kZXhcbiAgICAgICAgaWYgKHBhdGggPT09ICcvaW5kaWNlcycgJiYgaHR0cE1ldGhvZCA9PT0gJ1BPU1QnKSB7XG4gICAgICAgICAgICBjb25zdCB7IGluZGV4IH0gPSBqc29uQm9keTtcbiAgICAgICAgICAgIGF3YWl0IG9zQWRhcHRlci5jcmVhdGVJbmRleCh7IGluZGV4IH0pO1xuICAgICAgICAgICAgcmV0dXJuIGpzb24oMjAxLCB7IG1lc3NhZ2U6IGBJbmRleCAke2luZGV4fSBjcmVhdGVkYCB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIERFTEVURSAvaW5kaWNlcy97bmFtZX0gLT4gRGVsZXRlIEluZGV4XG4gICAgICAgIGlmIChwYXRoLnN0YXJ0c1dpdGgoJy9pbmRpY2VzLycpICYmIGh0dHBNZXRob2QgPT09ICdERUxFVEUnKSB7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IHBhdGguc3BsaXQoJy8nKVsyXTtcbiAgICAgICAgICAgIGF3YWl0IG9zQWRhcHRlci5kZWxldGVJbmRleCh7IGluZGV4IH0pO1xuICAgICAgICAgICAgcmV0dXJuIGpzb24oMjAwLCB7IG1lc3NhZ2U6IGBJbmRleCAke2luZGV4fSBkZWxldGVkYCB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFBVVCAvaW5kaWNlcy97bmFtZX0vbWFwcGluZyAtPiBVcGRhdGUgTWFwcGluZ1xuICAgICAgICBpZiAocGF0aC5zdGFydHNXaXRoKCcvaW5kaWNlcy8nKSAmJiBwYXRoLmVuZHNXaXRoKCcvbWFwcGluZycpICYmIGh0dHBNZXRob2QgPT09ICdQVVQnKSB7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IHBhdGguc3BsaXQoJy8nKVsyXTtcbiAgICAgICAgICAgIGNvbnN0IHsgcHJvcGVydGllcyB9ID0ganNvbkJvZHk7XG4gICAgICAgICAgICBhd2FpdCBvc0FkYXB0ZXIudXBkYXRlTWFwcGluZyh7XG4gICAgICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICAgICAgYm9keTogeyBwcm9wZXJ0aWVzIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGpzb24oMjAwLCB7IG1lc3NhZ2U6IGBNYXBwaW5nIHVwZGF0ZWQgZm9yICR7aW5kZXh9YCB9KTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgLy8gR0VUIC9pbmRpY2VzL3tuYW1lfS9tYXBwaW5nIC0+IEdldCBNYXBwaW5nXG4gICAgICAgIGlmIChwYXRoLnN0YXJ0c1dpdGgoJy9pbmRpY2VzLycpICYmIHBhdGguZW5kc1dpdGgoJy9tYXBwaW5nJykgJiYgaHR0cE1ldGhvZCA9PT0gJ0dFVCcpIHtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gcGF0aC5zcGxpdCgnLycpWzJdO1xuICAgICAgICAgICAgY29uc3QgbWFwcGluZyA9IGF3YWl0IG9zQWRhcHRlci5nZXRNYXBwaW5nKHsgaW5kZXggfSk7XG4gICAgICAgICAgICByZXR1cm4ganNvbigyMDAsIG1hcHBpbmcpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gR0VUIC9pbmRpY2VzL3tuYW1lfS9kb2N1bWVudHMve2lkfSAtPiBHZXQgRG9jdW1lbnRcbiAgICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aCgnL2luZGljZXMvJykgJiYgcGF0aC5pbmNsdWRlcygnL2RvY3VtZW50cy8nKSAmJiBodHRwTWV0aG9kID09PSAnR0VUJykge1xuICAgICAgICAgICAgY29uc3QgcGFydHMgPSBwYXRoLnNwbGl0KCcvJyk7XG4gICAgICAgICAgICAvLyAvaW5kaWNlcy97aW5kZXh9L2RvY3VtZW50cy97aWR9IC0+IFsnJywgJ2luZGljZXMnLCAnaW5kZXhOYW1lJywgJ2RvY3VtZW50cycsICdpZCddXG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IHBhcnRzWzJdO1xuICAgICAgICAgICAgY29uc3QgaWQgPSBwYXJ0c1s0XTtcblxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBkb2MgPSBhd2FpdCBvc0FkYXB0ZXIuZ2V0RG9jdW1lbnQoeyBpbmRleCwgaWQgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGpzb24oMjAwLCBkb2MpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICAgICAgICAgIGlmIChlcnJvci5tZXRhICYmIGVycm9yLm1ldGEuc3RhdHVzQ29kZSA9PT0gNDA0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uKDQwNCwgeyBtZXNzYWdlOiAnRG9jdW1lbnQgbm90IGZvdW5kJyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuXG4gICAgICAgIC8vIC0tLSBEeW5hbW9EQiBSb3V0ZXMgLS0tXG5cbiAgICAgICAgLy8gUE9TVCAvcmVjb3JkcyAtPiBBZGQgUmVjb3JkXG4gICAgICAgIGlmIChwYXRoID09PSAnL3JlY29yZHMnICYmIGh0dHBNZXRob2QgPT09ICdQT1NUJykge1xuICAgICAgICAgICAgY29uc3QgeyBpdGVtIH0gPSBqc29uQm9keTtcbiAgICAgICAgICAgIC8vIEFkYXB0ZXIgcmVxdWlyZXMgJ2lkJyBhbmQgJ3BrJyAoYW5kICdzaycpLlxuICAgICAgICAgICAgLy8gSWYgaW5jb21pbmcgaXRlbSBpbXBsaWVzIHBrIElTIHRoZSBpZCwgZW5zdXJlIGlkIGlzIHNldC5cbiAgICAgICAgICAgIC8vIEFsc28sICdjcmVhdGVPbmUnIGVuZm9yY2VzIGlkID09PSBwayBpZiBib3RoIGV4aXN0LlxuICAgICAgICAgICAgaWYgKGl0ZW0ucGsgJiYgIWl0ZW0uaWQpIHtcbiAgICAgICAgICAgICAgICBpdGVtLmlkID0gaXRlbS5waztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghaXRlbS5zaykge1xuICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIGlmIG5vdCBwcm92aWRlZCwgdGhvdWdoIHRlc3QgY3VycmVudGx5IHByb3ZpZGVzIGl0XG4gICAgICAgICAgICAgICAgaXRlbS5zayA9ICdtZXRhZGF0YSc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGF3YWl0IGR5bmFtb0FkYXB0ZXIuY3JlYXRlT25lKHtcbiAgICAgICAgICAgICAgICB0YWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgICAgICAgICAgICAgaXRlbTogaXRlbVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4ganNvbigyMDEsIHsgbWVzc2FnZTogJ1JlY29yZCBjcmVhdGVkJywgaXRlbSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIERFTEVURSAvcmVjb3Jkcy97aWR9IC0+IFJlbW92ZSBSZWNvcmRcbiAgICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aCgnL3JlY29yZHMvJykgJiYgaHR0cE1ldGhvZCA9PT0gJ0RFTEVURScpIHtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gcGF0aC5zcGxpdCgnLycpWzJdO1xuICAgICAgICAgICAgLy8gQWRhcHRlciAnZGVsZXRlT25lJyBpbnB1dDogeyB0YWJsZU5hbWUsIGl0ZW06IHsgcGssIHNrIH0gfVxuICAgICAgICAgICAgYXdhaXQgZHluYW1vQWRhcHRlci5kZWxldGVPbmUoe1xuICAgICAgICAgICAgICAgIHRhYmxlTmFtZTogVEFCTEVfTkFNRSxcbiAgICAgICAgICAgICAgICBpdGVtOiB7IHBrOiBpZCwgc2s6ICdtZXRhZGF0YScgfSAvLyBBc3N1bWluZyBzayBpcyAnbWV0YWRhdGEnIGJhc2VkIG9uIGNvbnZlbnRpb24vdGVzdFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4ganNvbigyMDAsIHsgbWVzc2FnZTogYFJlY29yZCAke2lkfSBkZWxldGVkYCB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFBBVENIIC9yZWNvcmRzL3tpZH0gLT4gUGF0Y2ggUmVjb3JkXG4gICAgICAgIGlmIChwYXRoLnN0YXJ0c1dpdGgoJy9yZWNvcmRzLycpICYmIGh0dHBNZXRob2QgPT09ICdQQVRDSCcpIHtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gcGF0aC5zcGxpdCgnLycpWzJdO1xuICAgICAgICAgICAgY29uc3QgeyBhdHRyaWJ1dGVzIH0gPSBqc29uQm9keTtcbiAgICAgICAgICAgIC8vIEFkYXB0ZXIgJ3BhdGNoT25lJyBpbnB1dDogeyB0YWJsZU5hbWUsIGl0ZW06IHsgcGssIHNrLCAuLi5hdHRyaWJ1dGVzIH0gfVxuICAgICAgICAgICAgY29uc3QgcGF0Y2hJdGVtID0ge1xuICAgICAgICAgICAgICAgIHBrOiBpZCxcbiAgICAgICAgICAgICAgICBzazogJ21ldGFkYXRhJyxcbiAgICAgICAgICAgICAgICAuLi5hdHRyaWJ1dGVzXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkeW5hbW9BZGFwdGVyLnBhdGNoT25lKHtcbiAgICAgICAgICAgICAgICB0YWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgICAgICAgICAgICAgaXRlbTogcGF0Y2hJdGVtXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBqc29uKDIwMCwgeyBtZXNzYWdlOiBgUmVjb3JkICR7aWR9IHBhdGNoZWRgLCByZXN1bHQgfSk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIHJldHVybiBqc29uKDQwNCwgeyBtZXNzYWdlOiAnUm91dGUgbm90IGZvdW5kJyB9KTtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNoaWxkTG9nZ2VyLmVycm9yKCdBUEkgRXJyb3InLCB7IGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiBTdHJpbmcoZXJyb3IpIH0gYXMgYW55KTtcbiAgICAgICAgcmV0dXJuIGpzb24oNTAwLCB7IGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InIH0pO1xuICAgIH1cbn0pO1xuXG5jb25zdCBqc29uID0gKHN0YXR1c0NvZGU6IG51bWJlciwgYm9keTogYW55KSA9PiAoe1xuICAgIHN0YXR1c0NvZGUsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoYm9keSksXG4gICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH1cbn0pO1xuIl19