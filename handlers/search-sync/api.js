"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_logger_1 = require("@vitkuz/aws-logger");
const opensearch_1 = require("@opensearch-project/opensearch");
const aws_opensearch_adapter_1 = require("@vitkuz/aws-opensearch-adapter");
const aws_dynamo_adapter_1 = require("@vitkuz/aws-dynamo-adapter");
const credential_provider_node_1 = require("@aws-sdk/credential-provider-node");
const aws_1 = require("@opensearch-project/opensearch/aws");
const OPENSEARCH_ENDPOINT = process.env.OPENSEARCH_ENDPOINT;
const TABLE_NAME = process.env.TABLE_NAME;
const REGION = process.env.AWS_REGION;
if (!OPENSEARCH_ENDPOINT || !TABLE_NAME || !REGION) {
    throw new Error('Missing environment variables');
}
const osClient = new opensearch_1.Client({
    ...(0, aws_1.AwsSigv4Signer)({
        region: REGION,
        service: 'es',
        getCredentials: () => (0, credential_provider_node_1.defaultProvider)()(),
    }),
    node: `https://${OPENSEARCH_ENDPOINT}` // Node must come after signer to work correctly with some versions, but standard spread works
});
const dynamoClientConfig = { region: REGION };
exports.handler = (0, aws_logger_1.withLogger)(async (event, context) => {
    const logger = (0, aws_logger_1.getLogger)();
    if (!logger)
        throw new Error('Logger missing');
    const headers = event.headers || {};
    // Extract request ID using custom key or keys from header
    const requestId = headers['x-request-id'] || headers['X-Request-Id'];
    // Create a child logger with the request ID
    const childLogger = logger.child(requestId ? { [aws_logger_1.REQUEST_ID_KEY]: requestId } : {});
    // Initialize adapters with the child logger
    const osAdapter = (0, aws_opensearch_adapter_1.createAdapter)({ client: osClient, logger: childLogger });
    const dynamoAdapter = (0, aws_dynamo_adapter_1.createAdapter)(dynamoClientConfig, childLogger);
    const { path, httpMethod, body } = event;
    const jsonBody = body ? JSON.parse(body) : {};
    childLogger.info('Search Sync API Request', { path, httpMethod, requestId });
    try {
        // --- OpenSearch Routes ---
        // POST /search -> Match Query
        if (path === '/search' && httpMethod === 'POST') {
            const { index, query } = jsonBody;
            // Using raw client for search as adapter likely lacks it (based on previous check)
            // Ideally we'd extend the adapter, but for now we use the client directly but log with our logger
            const result = await osClient.search({
                index,
                body: {
                    query: {
                        match: query
                    }
                }
            });
            return json(200, result.body);
        }
        // POST /indices -> Create Index
        if (path === '/indices' && httpMethod === 'POST') {
            const { index } = jsonBody;
            await osAdapter.createIndex({ index });
            return json(201, { message: `Index ${index} created` });
        }
        // DELETE /indices/{name} -> Delete Index
        if (path.startsWith('/indices/') && httpMethod === 'DELETE') {
            const index = path.split('/')[2];
            await osAdapter.deleteIndex({ index });
            return json(200, { message: `Index ${index} deleted` });
        }
        // PUT /indices/{name}/mapping -> Update Mapping
        if (path.startsWith('/indices/') && path.endsWith('/mapping') && httpMethod === 'PUT') {
            const index = path.split('/')[2];
            const { properties } = jsonBody;
            await osAdapter.updateMapping({
                index,
                body: { properties }
            });
            return json(200, { message: `Mapping updated for ${index}` });
        }
        // GET /indices/{name}/mapping -> Get Mapping
        if (path.startsWith('/indices/') && path.endsWith('/mapping') && httpMethod === 'GET') {
            const index = path.split('/')[2];
            const mapping = await osAdapter.getMapping({ index });
            return json(200, mapping);
        }
        // --- DynamoDB Routes ---
        // POST /records -> Add Record
        if (path === '/records' && httpMethod === 'POST') {
            const { item } = jsonBody;
            // Adapter requires 'id' and 'pk' (and 'sk').
            // If incoming item implies pk IS the id, ensure id is set.
            // Also, 'createOne' enforces id === pk if both exist.
            if (item.pk && !item.id) {
                item.id = item.pk;
            }
            if (!item.sk) {
                // Fallback if not provided, though test currently provides it
                item.sk = 'metadata';
            }
            await dynamoAdapter.createOne({
                tableName: TABLE_NAME,
                item: item
            });
            return json(201, { message: 'Record created', item });
        }
        // DELETE /records/{id} -> Remove Record
        if (path.startsWith('/records/') && httpMethod === 'DELETE') {
            const id = path.split('/')[2];
            // Adapter 'deleteOne' input: { tableName, item: { pk, sk } }
            await dynamoAdapter.deleteOne({
                tableName: TABLE_NAME,
                item: { pk: id, sk: 'metadata' } // Assuming sk is 'metadata' based on convention/test
            });
            return json(200, { message: `Record ${id} deleted` });
        }
        // PATCH /records/{id} -> Patch Record
        if (path.startsWith('/records/') && httpMethod === 'PATCH') {
            const id = path.split('/')[2];
            const { attributes } = jsonBody;
            // Adapter 'patchOne' input: { tableName, item: { pk, sk, ...attributes } }
            const patchItem = {
                pk: id,
                sk: 'metadata',
                ...attributes
            };
            const result = await dynamoAdapter.patchOne({
                tableName: TABLE_NAME,
                item: patchItem
            });
            return json(200, { message: `Record ${id} patched`, result });
        }
        return json(404, { message: 'Route not found' });
    }
    catch (error) {
        childLogger.error('API Error', error instanceof Error ? error : String(error));
        return json(500, { error: error instanceof Error ? error.message : 'Internal Server Error' });
    }
});
const json = (statusCode, body) => ({
    statusCode,
    body: JSON.stringify(body),
    headers: { 'Content-Type': 'application/json' }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBpLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLG1EQUEyRTtBQUMzRSwrREFBd0Q7QUFDeEQsMkVBQWtGO0FBQ2xGLG1FQUFrRjtBQUNsRixnRkFBb0U7QUFDcEUsNERBQW9FO0FBRXBFLE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQztBQUM1RCxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQztBQUMxQyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQztBQUV0QyxJQUFJLENBQUMsbUJBQW1CLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNqRCxNQUFNLElBQUksS0FBSyxDQUFDLCtCQUErQixDQUFDLENBQUM7QUFDckQsQ0FBQztBQUVELE1BQU0sUUFBUSxHQUFHLElBQUksbUJBQU0sQ0FBQztJQUN4QixHQUFHLElBQUEsb0JBQWMsRUFBQztRQUNkLE1BQU0sRUFBRSxNQUFNO1FBQ2QsT0FBTyxFQUFFLElBQUk7UUFDYixjQUFjLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBQSwwQ0FBZSxHQUFFLEVBQUU7S0FDNUMsQ0FBQztJQUNGLElBQUksRUFBRSxXQUFXLG1CQUFtQixFQUFFLENBQUMsOEZBQThGO0NBQ3hJLENBQUMsQ0FBQztBQUVILE1BQU0sa0JBQWtCLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUM7QUFFakMsUUFBQSxPQUFPLEdBQUcsSUFBQSx1QkFBVSxFQUFDLEtBQUssRUFBRSxLQUEyQixFQUFFLE9BQWdCLEVBQUUsRUFBRTtJQUN0RixNQUFNLE1BQU0sR0FBRyxJQUFBLHNCQUFTLEdBQUUsQ0FBQztJQUMzQixJQUFJLENBQUMsTUFBTTtRQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJ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QU0sR0FBRyxNQUFNLGFBQWEsQ0FBQyxRQUFRLENBQUM7Z0JBQ3hDLFNBQVMsRUFBRSxVQUFVO2dCQUNyQixJQUFJLEVBQUUsU0FBUzthQUNsQixDQUFDLENBQUM7WUFDSCxPQUFPLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ2xFLENBQUM7UUFHRCxPQUFPLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO0lBRXJELENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2IsV0FBVyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUMvRSxPQUFPLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDO0lBQ2xHLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILE1BQU0sSUFBSSxHQUFHLENBQUMsVUFBa0IsRUFBRSxJQUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDN0MsVUFBVTtJQUNWLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztJQUMxQixPQUFPLEVBQUUsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUU7Q0FDbEQsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IHdpdGhMb2dnZXIsIGdldExvZ2dlciwgUkVRVUVTVF9JRF9LRVkgfSBmcm9tICdAdml0a3V6L2F3cy1sb2dnZXInO1xuaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSAnQG9wZW5zZWFyY2gtcHJvamVjdC9vcGVuc2VhcmNoJztcbmltcG9ydCB7IGNyZWF0ZUFkYXB0ZXIgYXMgY3JlYXRlT3NBZGFwdGVyIH0gZnJvbSAnQHZpdGt1ei9hd3Mtb3BlbnNlYXJjaC1hZGFwdGVyJztcbmltcG9ydCB7IGNyZWF0ZUFkYXB0ZXIgYXMgY3JlYXRlRHluYW1vQWRhcHRlciB9IGZyb20gJ0B2aXRrdXovYXdzLWR5bmFtby1hZGFwdGVyJztcbmltcG9ydCB7IGRlZmF1bHRQcm92aWRlciB9IGZyb20gJ0Bhd3Mtc2RrL2NyZWRlbnRpYWwtcHJvdmlkZXItbm9kZSc7XG5pbXBvcnQgeyBBd3NTaWd2NFNpZ25lciB9IGZyb20gJ0BvcGVuc2VhcmNoLXByb2plY3Qvb3BlbnNlYXJjaC9hd3MnO1xuXG5jb25zdCBPUEVOU0VBUkNIX0VORFBPSU5UID0gcHJvY2Vzcy5lbnYuT1BFTlNFQVJDSF9FTkRQT0lOVDtcbmNvbnN0IFRBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5UQUJMRV9OQU1FO1xuY29uc3QgUkVHSU9OID0gcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTjtcblxuaWYgKCFPUEVOU0VBUkNIX0VORFBPSU5UIHx8ICFUQUJMRV9OQU1FIHx8ICFSRUdJT04pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgZW52aXJvbm1lbnQgdmFyaWFibGVzJyk7XG59XG5cbmNvbnN0IG9zQ2xpZW50ID0gbmV3IENsaWVudCh7XG4gICAgLi4uQXdzU2lndjRTaWduZXIoe1xuICAgICAgICByZWdpb246IFJFR0lPTixcbiAgICAgICAgc2VydmljZTogJ2VzJyxcbiAgICAgICAgZ2V0Q3JlZGVudGlhbHM6ICgpID0+IGRlZmF1bHRQcm92aWRlcigpKCksXG4gICAgfSksXG4gICAgbm9kZTogYGh0dHBzOi8vJHtPUEVOU0VBUkNIX0VORFBPSU5UfWAgLy8gTm9kZSBtdXN0IGNvbWUgYWZ0ZXIgc2lnbmVyIHRvIHdvcmsgY29ycmVjdGx5IHdpdGggc29tZSB2ZXJzaW9ucywgYnV0IHN0YW5kYXJkIHNwcmVhZCB3b3Jrc1xufSk7XG5cbmNvbnN0IGR5bmFtb0NsaWVudENvbmZpZyA9IHsgcmVnaW9uOiBSRUdJT04gfTtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSB3aXRoTG9nZ2VyKGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQsIGNvbnRleHQ6IENvbnRleHQpID0+IHtcbiAgICBjb25zdCBsb2dnZXIgPSBnZXRMb2dnZXIoKTtcbiAgICBpZiAoIWxvZ2dlcikgdGhyb3cgbmV3IEVycm9yKCdMb2dnZXIgbWlzc2luZycpO1xuXG4gICAgY29uc3QgaGVhZGVycyA9IGV2ZW50LmhlYWRlcnMgfHwge307XG4gICAgLy8gRXh0cmFjdCByZXF1ZXN0IElEIHVzaW5nIGN1c3RvbSBrZXkgb3Iga2V5cyBmcm9tIGhlYWRlclxuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGhlYWRlcnNbJ3gtcmVxdWVzdC1pZCddIHx8IGhlYWRlcnNbJ1gtUmVxdWVzdC1JZCddO1xuXG4gICAgLy8gQ3JlYXRlIGEgY2hpbGQgbG9nZ2VyIHdpdGggdGhlIHJlcXVlc3QgSURcbiAgICBjb25zdCBjaGlsZExvZ2dlciA9IGxvZ2dlci5jaGlsZChyZXF1ZXN0SWQgPyB7IFtSRVFVRVNUX0lEX0tFWV06IHJlcXVlc3RJZCB9IDoge30pO1xuXG4gICAgLy8gSW5pdGlhbGl6ZSBhZGFwdGVycyB3aXRoIHRoZSBjaGlsZCBsb2dnZXJcbiAgICBjb25zdCBvc0FkYXB0ZXIgPSBjcmVhdGVPc0FkYXB0ZXIoeyBjbGllbnQ6IG9zQ2xpZW50LCBsb2dnZXI6IGNoaWxkTG9nZ2VyIH0pO1xuICAgIGNvbnN0IGR5bmFtb0FkYXB0ZXIgPSBjcmVhdGVEeW5hbW9BZGFwdGVyKGR5bmFtb0NsaWVudENvbmZpZywgY2hpbGRMb2dnZXIpO1xuXG4gICAgY29uc3QgeyBwYXRoLCBodHRwTWV0aG9kLCBib2R5IH0gPSBldmVudDtcbiAgICBjb25zdCBqc29uQm9keSA9IGJvZHkgPyBKU09OLnBhcnNlKGJvZHkpIDoge307XG5cbiAgICBjaGlsZExvZ2dlci5pbmZvKCdTZWFyY2ggU3luYyBBUEkgUmVxdWVzdCcsIHsgcGF0aCwgaHR0cE1ldGhvZCwgcmVxdWVzdElkIH0pO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgLy8gLS0tIE9wZW5TZWFyY2ggUm91dGVzIC0tLVxuXG4gICAgICAgIC8vIFBPU1QgL3NlYXJjaCAtPiBNYXRjaCBRdWVyeVxuICAgICAgICBpZiAocGF0aCA9PT0gJy9zZWFyY2gnICYmIGh0dHBNZXRob2QgPT09ICdQT1NUJykge1xuICAgICAgICAgICAgY29uc3QgeyBpbmRleCwgcXVlcnkgfSA9IGpzb25Cb2R5O1xuICAgICAgICAgICAgLy8gVXNpbmcgcmF3IGNsaWVudCBmb3Igc2VhcmNoIGFzIGFkYXB0ZXIgbGlrZWx5IGxhY2tzIGl0IChiYXNlZCBvbiBwcmV2aW91cyBjaGVjaylcbiAgICAgICAgICAgIC8vIElkZWFsbHkgd2UnZCBleHRlbmQgdGhlIGFkYXB0ZXIsIGJ1dCBmb3Igbm93IHdlIHVzZSB0aGUgY2xpZW50IGRpcmVjdGx5IGJ1dCBsb2cgd2l0aCBvdXIgbG9nZ2VyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBvc0NsaWVudC5zZWFyY2goe1xuICAgICAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgICAgIGJvZHk6IHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnk6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoOiBxdWVyeVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4ganNvbigyMDAsIHJlc3VsdC5ib2R5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFBPU1QgL2luZGljZXMgLT4gQ3JlYXRlIEluZGV4XG4gICAgICAgIGlmIChwYXRoID09PSAnL2luZGljZXMnICYmIGh0dHBNZXRob2QgPT09ICdQT1NUJykge1xuICAgICAgICAgICAgY29uc3QgeyBpbmRleCB9ID0ganNvbkJvZHk7XG4gICAgICAgICAgICBhd2FpdCBvc0FkYXB0ZXIuY3JlYXRlSW5kZXgoeyBpbmRleCB9KTtcbiAgICAgICAgICAgIHJldHVybiBqc29uKDIwMSwgeyBtZXNzYWdlOiBgSW5kZXggJHtpbmRleH0gY3JlYXRlZGAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBERUxFVEUgL2luZGljZXMve25hbWV9IC0+IERlbGV0ZSBJbmRleFxuICAgICAgICBpZiAocGF0aC5zdGFydHNXaXRoKCcvaW5kaWNlcy8nKSAmJiBodHRwTWV0aG9kID09PSAnREVMRVRFJykge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSBwYXRoLnNwbGl0KCcvJylbMl07XG4gICAgICAgICAgICBhd2FpdCBvc0FkYXB0ZXIuZGVsZXRlSW5kZXgoeyBpbmRleCB9KTtcbiAgICAgICAgICAgIHJldHVybiBqc29uKDIwMCwgeyBtZXNzYWdlOiBgSW5kZXggJHtpbmRleH0gZGVsZXRlZGAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBQVVQgL2luZGljZXMve25hbWV9L21hcHBpbmcgLT4gVXBkYXRlIE1hcHBpbmdcbiAgICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aCgnL2luZGljZXMvJykgJiYgcGF0aC5lbmRzV2l0aCgnL21hcHBpbmcnKSAmJiBodHRwTWV0aG9kID09PSAnUFVUJykge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSBwYXRoLnNwbGl0KCcvJylbMl07XG4gICAgICAgICAgICBjb25zdCB7IHByb3BlcnRpZXMgfSA9IGpzb25Cb2R5O1xuICAgICAgICAgICAgYXdhaXQgb3NBZGFwdGVyLnVwZGF0ZU1hcHBpbmcoe1xuICAgICAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgICAgIGJvZHk6IHsgcHJvcGVydGllcyB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBqc29uKDIwMCwgeyBtZXNzYWdlOiBgTWFwcGluZyB1cGRhdGVkIGZvciAke2luZGV4fWAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBHRVQgL2luZGljZXMve25hbWV9L21hcHBpbmcgLT4gR2V0IE1hcHBpbmdcbiAgICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aCgnL2luZGljZXMvJykgJiYgcGF0aC5lbmRzV2l0aCgnL21hcHBpbmcnKSAmJiBodHRwTWV0aG9kID09PSAnR0VUJykge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSBwYXRoLnNwbGl0KCcvJylbMl07XG4gICAgICAgICAgICBjb25zdCBtYXBwaW5nID0gYXdhaXQgb3NBZGFwdGVyLmdldE1hcHBpbmcoeyBpbmRleCB9KTtcbiAgICAgICAgICAgIHJldHVybiBqc29uKDIwMCwgbWFwcGluZyk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIC8vIC0tLSBEeW5hbW9EQiBSb3V0ZXMgLS0tXG5cbiAgICAgICAgLy8gUE9TVCAvcmVjb3JkcyAtPiBBZGQgUmVjb3JkXG4gICAgICAgIGlmIChwYXRoID09PSAnL3JlY29yZHMnICYmIGh0dHBNZXRob2QgPT09ICdQT1NUJykge1xuICAgICAgICAgICAgY29uc3QgeyBpdGVtIH0gPSBqc29uQm9keTtcbiAgICAgICAgICAgIC8vIEFkYXB0ZXIgcmVxdWlyZXMgJ2lkJyBhbmQgJ3BrJyAoYW5kICdzaycpLlxuICAgICAgICAgICAgLy8gSWYgaW5jb21pbmcgaXRlbSBpbXBsaWVzIHBrIElTIHRoZSBpZCwgZW5zdXJlIGlkIGlzIHNldC5cbiAgICAgICAgICAgIC8vIEFsc28sICdjcmVhdGVPbmUnIGVuZm9yY2VzIGlkID09PSBwayBpZiBib3RoIGV4aXN0LlxuICAgICAgICAgICAgaWYgKGl0ZW0ucGsgJiYgIWl0ZW0uaWQpIHtcbiAgICAgICAgICAgICAgICBpdGVtLmlkID0gaXRlbS5waztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghaXRlbS5zaykge1xuICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIGlmIG5vdCBwcm92aWRlZCwgdGhvdWdoIHRlc3QgY3VycmVudGx5IHByb3ZpZGVzIGl0XG4gICAgICAgICAgICAgICAgaXRlbS5zayA9ICdtZXRhZGF0YSc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGF3YWl0IGR5bmFtb0FkYXB0ZXIuY3JlYXRlT25lKHtcbiAgICAgICAgICAgICAgICB0YWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgICAgICAgICAgICAgaXRlbTogaXRlbVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4ganNvbigyMDEsIHsgbWVzc2FnZTogJ1JlY29yZCBjcmVhdGVkJywgaXRlbSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIERFTEVURSAvcmVjb3Jkcy97aWR9IC0+IFJlbW92ZSBSZWNvcmRcbiAgICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aCgnL3JlY29yZHMvJykgJiYgaHR0cE1ldGhvZCA9PT0gJ0RFTEVURScpIHtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gcGF0aC5zcGxpdCgnLycpWzJdO1xuICAgICAgICAgICAgLy8gQWRhcHRlciAnZGVsZXRlT25lJyBpbnB1dDogeyB0YWJsZU5hbWUsIGl0ZW06IHsgcGssIHNrIH0gfVxuICAgICAgICAgICAgYXdhaXQgZHluYW1vQWRhcHRlci5kZWxldGVPbmUoe1xuICAgICAgICAgICAgICAgIHRhYmxlTmFtZTogVEFCTEVfTkFNRSxcbiAgICAgICAgICAgICAgICBpdGVtOiB7IHBrOiBpZCwgc2s6ICdtZXRhZGF0YScgfSAvLyBBc3N1bWluZyBzayBpcyAnbWV0YWRhdGEnIGJhc2VkIG9uIGNvbnZlbnRpb24vdGVzdFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4ganNvbigyMDAsIHsgbWVzc2FnZTogYFJlY29yZCAke2lkfSBkZWxldGVkYCB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFBBVENIIC9yZWNvcmRzL3tpZH0gLT4gUGF0Y2ggUmVjb3JkXG4gICAgICAgIGlmIChwYXRoLnN0YXJ0c1dpdGgoJy9yZWNvcmRzLycpICYmIGh0dHBNZXRob2QgPT09ICdQQVRDSCcpIHtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gcGF0aC5zcGxpdCgnLycpWzJdO1xuICAgICAgICAgICAgY29uc3QgeyBhdHRyaWJ1dGVzIH0gPSBqc29uQm9keTtcbiAgICAgICAgICAgIC8vIEFkYXB0ZXIgJ3BhdGNoT25lJyBpbnB1dDogeyB0YWJsZU5hbWUsIGl0ZW06IHsgcGssIHNrLCAuLi5hdHRyaWJ1dGVzIH0gfVxuICAgICAgICAgICAgY29uc3QgcGF0Y2hJdGVtID0ge1xuICAgICAgICAgICAgICAgIHBrOiBpZCxcbiAgICAgICAgICAgICAgICBzazogJ21ldGFkYXRhJyxcbiAgICAgICAgICAgICAgICAuLi5hdHRyaWJ1dGVzXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkeW5hbW9BZGFwdGVyLnBhdGNoT25lKHtcbiAgICAgICAgICAgICAgICB0YWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgICAgICAgICAgICAgaXRlbTogcGF0Y2hJdGVtXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBqc29uKDIwMCwgeyBtZXNzYWdlOiBgUmVjb3JkICR7aWR9IHBhdGNoZWRgLCByZXN1bHQgfSk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIHJldHVybiBqc29uKDQwNCwgeyBtZXNzYWdlOiAnUm91dGUgbm90IGZvdW5kJyB9KTtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNoaWxkTG9nZ2VyLmVycm9yKCdBUEkgRXJyb3InLCBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiBTdHJpbmcoZXJyb3IpKTtcbiAgICAgICAgcmV0dXJuIGpzb24oNTAwLCB7IGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InIH0pO1xuICAgIH1cbn0pO1xuXG5jb25zdCBqc29uID0gKHN0YXR1c0NvZGU6IG51bWJlciwgYm9keTogYW55KSA9PiAoe1xuICAgIHN0YXR1c0NvZGUsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoYm9keSksXG4gICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH1cbn0pO1xuIl19