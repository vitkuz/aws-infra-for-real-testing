"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_logger_1 = require("@vitkuz/aws-logger");
exports.handler = (0, aws_logger_1.withLogger)(async (event, context) => {
    const logger = (0, aws_logger_1.getLogger)();
    if (!logger)
        throw new Error('Logger context missing');
    logger.info('SQS Processor Invoked', { recordCount: event.Records.length });
    // We can't log the whole event as JSON easily without it beind huge, 
    // but the logger handles object passed as meta.
    for (const record of event.Records) {
        let requestId;
        let snsMessage;
        try {
            // SQS body is the SNS envelope
            const snsEnvelope = JSON.parse(record.body);
            const messageAttributes = snsEnvelope.MessageAttributes;
            requestId = messageAttributes?.[aws_logger_1.REQUEST_ID_KEY]?.Value;
            snsMessage = snsEnvelope.Message;
        }
        catch (error) {
            logger.error('Error parsing SQS body', error instanceof Error ? error : String(error), { body: record.body });
        }
        const childLogger = logger.child(requestId ? { [aws_logger_1.REQUEST_ID_KEY]: requestId } : {});
        childLogger.info('Processing SQS Record', {
            messageId: record.messageId,
            snsMessage // Logging the inner message content
        });
        if (!requestId) {
            childLogger.warn('No x-request-id found in message attributes');
        }
    }
    return { statusCode: 200, body: `Processed ${event.Records.length} records` };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FzLXByb2Nlc3Nvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNxcy1wcm9jZXNzb3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsbURBQTJFO0FBRTlELFFBQUEsT0FBTyxHQUFHLElBQUEsdUJBQVUsRUFBQyxLQUFLLEVBQUUsS0FBZSxFQUFFLE9BQWdCLEVBQUUsRUFBRTtJQUMxRSxNQUFNLE1BQU0sR0FBRyxJQUFBLHNCQUFTLEdBQUUsQ0FBQztJQUMzQixJQUFJLENBQUMsTUFBTTtRQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztJQUV2RCxNQUFNLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLEVBQUUsV0FBVyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUU1RSxzRUFBc0U7SUFDdEUsZ0RBQWdEO0lBRWhELEtBQUssTUFBTSxNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2pDLElBQUksU0FBNkIsQ0FBQztRQUNsQyxJQUFJLFVBQThCLENBQUM7UUFFbkMsSUFBSSxDQUFDO1lBQ0QsK0JBQStCO1lBQy9CLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVDLE1BQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDLGlCQUFpQixDQUFDO1lBQ3hELFNBQVMsR0FBRyxpQkFBaUIsRUFBRSxDQUFDLDJCQUFjLENBQUMsRUFBRSxLQUFLLENBQUM7WUFDdkQsVUFBVSxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDckMsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDYixNQUFNLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ2xILENBQUM7UUFFRCxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLDJCQUFjLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFbkYsV0FBVyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRTtZQUN0QyxTQUFTLEVBQUUsTUFBTSxDQUFDLFNBQVM7WUFDM0IsVUFBVSxDQUFDLG9DQUFvQztTQUNsRCxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDYixXQUFXLENBQUMsSUFBSSxDQUFDLDZDQUE2QyxDQUFDLENBQUM7UUFDcEUsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsYUFBYSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sVUFBVSxFQUFFLENBQUM7QUFDbEYsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTUVNFdmVudCwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgd2l0aExvZ2dlciwgZ2V0TG9nZ2VyLCBSRVFVRVNUX0lEX0tFWSB9IGZyb20gJ0B2aXRrdXovYXdzLWxvZ2dlcic7XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gd2l0aExvZ2dlcihhc3luYyAoZXZlbnQ6IFNRU0V2ZW50LCBjb250ZXh0OiBDb250ZXh0KSA9PiB7XG4gICAgY29uc3QgbG9nZ2VyID0gZ2V0TG9nZ2VyKCk7XG4gICAgaWYgKCFsb2dnZXIpIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIGNvbnRleHQgbWlzc2luZycpO1xuXG4gICAgbG9nZ2VyLmluZm8oJ1NRUyBQcm9jZXNzb3IgSW52b2tlZCcsIHsgcmVjb3JkQ291bnQ6IGV2ZW50LlJlY29yZHMubGVuZ3RoIH0pO1xuXG4gICAgLy8gV2UgY2FuJ3QgbG9nIHRoZSB3aG9sZSBldmVudCBhcyBKU09OIGVhc2lseSB3aXRob3V0IGl0IGJlaW5kIGh1Z2UsIFxuICAgIC8vIGJ1dCB0aGUgbG9nZ2VyIGhhbmRsZXMgb2JqZWN0IHBhc3NlZCBhcyBtZXRhLlxuXG4gICAgZm9yIChjb25zdCByZWNvcmQgb2YgZXZlbnQuUmVjb3Jkcykge1xuICAgICAgICBsZXQgcmVxdWVzdElkOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBzbnNNZXNzYWdlOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIFNRUyBib2R5IGlzIHRoZSBTTlMgZW52ZWxvcGVcbiAgICAgICAgICAgIGNvbnN0IHNuc0VudmVsb3BlID0gSlNPTi5wYXJzZShyZWNvcmQuYm9keSk7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlQXR0cmlidXRlcyA9IHNuc0VudmVsb3BlLk1lc3NhZ2VBdHRyaWJ1dGVzO1xuICAgICAgICAgICAgcmVxdWVzdElkID0gbWVzc2FnZUF0dHJpYnV0ZXM/LltSRVFVRVNUX0lEX0tFWV0/LlZhbHVlO1xuICAgICAgICAgICAgc25zTWVzc2FnZSA9IHNuc0VudmVsb3BlLk1lc3NhZ2U7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHBhcnNpbmcgU1FTIGJvZHknLCBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiBTdHJpbmcoZXJyb3IpLCB7IGJvZHk6IHJlY29yZC5ib2R5IH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2hpbGRMb2dnZXIgPSBsb2dnZXIuY2hpbGQocmVxdWVzdElkID8geyBbUkVRVUVTVF9JRF9LRVldOiByZXF1ZXN0SWQgfSA6IHt9KTtcblxuICAgICAgICBjaGlsZExvZ2dlci5pbmZvKCdQcm9jZXNzaW5nIFNRUyBSZWNvcmQnLCB7XG4gICAgICAgICAgICBtZXNzYWdlSWQ6IHJlY29yZC5tZXNzYWdlSWQsXG4gICAgICAgICAgICBzbnNNZXNzYWdlIC8vIExvZ2dpbmcgdGhlIGlubmVyIG1lc3NhZ2UgY29udGVudFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoIXJlcXVlc3RJZCkge1xuICAgICAgICAgICAgY2hpbGRMb2dnZXIud2FybignTm8geC1yZXF1ZXN0LWlkIGZvdW5kIGluIG1lc3NhZ2UgYXR0cmlidXRlcycpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBib2R5OiBgUHJvY2Vzc2VkICR7ZXZlbnQuUmVjb3Jkcy5sZW5ndGh9IHJlY29yZHNgIH07XG59KTtcbiJdfQ==