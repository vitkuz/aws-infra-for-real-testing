"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_logger_1 = require("@vitkuz/aws-logger");
const schema_1 = require("./schema");
exports.handler = (0, aws_logger_1.withLogger)(async (event, context) => {
    const logger = (0, aws_logger_1.getLogger)();
    if (!logger)
        throw new Error('Logger context missing');
    // Note: 'withLogger' automatically logs execution start with event and context summary.
    logger.info('SQS Processor Invoked', { data: { recordCount: event.Records.length } });
    for (const record of event.Records) {
        let requestId;
        let snsMessage;
        // Parse SNS Envelope using Zod
        let parsedBody;
        try {
            parsedBody = JSON.parse(record.body);
        }
        catch (error) {
            logger.error('Failed to parse SQS body as JSON', { error, data: { body: record.body } });
            continue;
        }
        const envelopeResult = schema_1.SnsEnvelopeSchema.safeParse(parsedBody);
        if (!envelopeResult.success) {
            logger.error('Invalid SNS Envelope structure', { error: envelopeResult.error, data: { body: record.body } });
            continue;
        }
        const snsEnvelope = envelopeResult.data;
        const messageAttributes = snsEnvelope.MessageAttributes;
        // Extract Request ID if present
        if (messageAttributes && messageAttributes[aws_logger_1.REQUEST_ID_KEY]) {
            requestId = messageAttributes[aws_logger_1.REQUEST_ID_KEY].Value;
        }
        snsMessage = snsEnvelope.Message;
        const childLogger = logger.child(requestId ? { [aws_logger_1.REQUEST_ID_KEY]: requestId } : {});
        childLogger.info('Processing SQS Record', {
            data: {
                messageId: record.messageId,
                snsMessage // Logging the inner message content
            }
        });
        if (!requestId) {
            childLogger.warn('No x-request-id found in message attributes');
        }
    }
    return { statusCode: 200, body: `Processed ${event.Records.length} records` };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxtREFBMkU7QUFDM0UscUNBQTZDO0FBRWhDLFFBQUEsT0FBTyxHQUFHLElBQUEsdUJBQVUsRUFBQyxLQUFLLEVBQUUsS0FBZSxFQUFFLE9BQWdCLEVBQUUsRUFBRTtJQUMxRSxNQUFNLE1BQU0sR0FBRyxJQUFBLHNCQUFTLEdBQUUsQ0FBQztJQUMzQixJQUFJLENBQUMsTUFBTTtRQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztJQUV2RCx3RkFBd0Y7SUFFeEYsTUFBTSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztJQUV0RixLQUFLLE1BQU0sTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNqQyxJQUFJLFNBQTZCLENBQUM7UUFDbEMsSUFBSSxVQUE4QixDQUFDO1FBRW5DLCtCQUErQjtRQUMvQixJQUFJLFVBQW1CLENBQUM7UUFDeEIsSUFBSSxDQUFDO1lBQ0QsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2IsTUFBTSxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksRUFBRSxFQUFTLENBQUMsQ0FBQztZQUNoRyxTQUFTO1FBQ2IsQ0FBQztRQUVELE1BQU0sY0FBYyxHQUFHLDBCQUFpQixDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUUvRCxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQzFCLE1BQU0sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLEVBQUUsRUFBRSxLQUFLLEVBQUUsY0FBYyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksRUFBRSxFQUFTLENBQUMsQ0FBQztZQUNwSCxTQUFTO1FBQ2IsQ0FBQztRQUVELE1BQU0sV0FBVyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUM7UUFDeEMsTUFBTSxpQkFBaUIsR0FBRyxXQUFXLENBQUMsaUJBQWlCLENBQUM7UUFFeEQsZ0NBQWdDO1FBQ2hDLElBQUksaUJBQWlCLElBQUksaUJBQWlCLENBQUMsMkJBQWMsQ0FBQyxFQUFFLENBQUM7WUFDekQsU0FBUyxHQUFHLGlCQUFpQixDQUFDLDJCQUFjLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDeEQsQ0FBQztRQUVELFVBQVUsR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBRWpDLE1BQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsMkJBQWMsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVuRixXQUFXLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFO1lBQ3RDLElBQUksRUFBRTtnQkFDRixTQUFTLEVBQUUsTUFBTSxDQUFDLFNBQVM7Z0JBQzNCLFVBQVUsQ0FBQyxvQ0FBb0M7YUFDbEQ7U0FDSixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDYixXQUFXLENBQUMsSUFBSSxDQUFDLDZDQUE2QyxDQUFDLENBQUM7UUFDcEUsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsYUFBYSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sVUFBVSxFQUFFLENBQUM7QUFDbEYsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTUVNFdmVudCwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgd2l0aExvZ2dlciwgZ2V0TG9nZ2VyLCBSRVFVRVNUX0lEX0tFWSB9IGZyb20gJ0B2aXRrdXovYXdzLWxvZ2dlcic7XG5pbXBvcnQgeyBTbnNFbnZlbG9wZVNjaGVtYSB9IGZyb20gJy4vc2NoZW1hJztcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSB3aXRoTG9nZ2VyKGFzeW5jIChldmVudDogU1FTRXZlbnQsIGNvbnRleHQ6IENvbnRleHQpID0+IHtcbiAgICBjb25zdCBsb2dnZXIgPSBnZXRMb2dnZXIoKTtcbiAgICBpZiAoIWxvZ2dlcikgdGhyb3cgbmV3IEVycm9yKCdMb2dnZXIgY29udGV4dCBtaXNzaW5nJyk7XG5cbiAgICAvLyBOb3RlOiAnd2l0aExvZ2dlcicgYXV0b21hdGljYWxseSBsb2dzIGV4ZWN1dGlvbiBzdGFydCB3aXRoIGV2ZW50IGFuZCBjb250ZXh0IHN1bW1hcnkuXG5cbiAgICBsb2dnZXIuaW5mbygnU1FTIFByb2Nlc3NvciBJbnZva2VkJywgeyBkYXRhOiB7IHJlY29yZENvdW50OiBldmVudC5SZWNvcmRzLmxlbmd0aCB9IH0pO1xuXG4gICAgZm9yIChjb25zdCByZWNvcmQgb2YgZXZlbnQuUmVjb3Jkcykge1xuICAgICAgICBsZXQgcmVxdWVzdElkOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBzbnNNZXNzYWdlOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICAgICAgLy8gUGFyc2UgU05TIEVudmVsb3BlIHVzaW5nIFpvZFxuICAgICAgICBsZXQgcGFyc2VkQm9keTogdW5rbm93bjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHBhcnNlZEJvZHkgPSBKU09OLnBhcnNlKHJlY29yZC5ib2R5KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHBhcnNlIFNRUyBib2R5IGFzIEpTT04nLCB7IGVycm9yLCBkYXRhOiB7IGJvZHk6IHJlY29yZC5ib2R5IH0gfSBhcyBhbnkpO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBlbnZlbG9wZVJlc3VsdCA9IFNuc0VudmVsb3BlU2NoZW1hLnNhZmVQYXJzZShwYXJzZWRCb2R5KTtcblxuICAgICAgICBpZiAoIWVudmVsb3BlUmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcignSW52YWxpZCBTTlMgRW52ZWxvcGUgc3RydWN0dXJlJywgeyBlcnJvcjogZW52ZWxvcGVSZXN1bHQuZXJyb3IsIGRhdGE6IHsgYm9keTogcmVjb3JkLmJvZHkgfSB9IGFzIGFueSk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNuc0VudmVsb3BlID0gZW52ZWxvcGVSZXN1bHQuZGF0YTtcbiAgICAgICAgY29uc3QgbWVzc2FnZUF0dHJpYnV0ZXMgPSBzbnNFbnZlbG9wZS5NZXNzYWdlQXR0cmlidXRlcztcblxuICAgICAgICAvLyBFeHRyYWN0IFJlcXVlc3QgSUQgaWYgcHJlc2VudFxuICAgICAgICBpZiAobWVzc2FnZUF0dHJpYnV0ZXMgJiYgbWVzc2FnZUF0dHJpYnV0ZXNbUkVRVUVTVF9JRF9LRVldKSB7XG4gICAgICAgICAgICByZXF1ZXN0SWQgPSBtZXNzYWdlQXR0cmlidXRlc1tSRVFVRVNUX0lEX0tFWV0uVmFsdWU7XG4gICAgICAgIH1cblxuICAgICAgICBzbnNNZXNzYWdlID0gc25zRW52ZWxvcGUuTWVzc2FnZTtcblxuICAgICAgICBjb25zdCBjaGlsZExvZ2dlciA9IGxvZ2dlci5jaGlsZChyZXF1ZXN0SWQgPyB7IFtSRVFVRVNUX0lEX0tFWV06IHJlcXVlc3RJZCB9IDoge30pO1xuXG4gICAgICAgIGNoaWxkTG9nZ2VyLmluZm8oJ1Byb2Nlc3NpbmcgU1FTIFJlY29yZCcsIHtcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlSWQ6IHJlY29yZC5tZXNzYWdlSWQsXG4gICAgICAgICAgICAgICAgc25zTWVzc2FnZSAvLyBMb2dnaW5nIHRoZSBpbm5lciBtZXNzYWdlIGNvbnRlbnRcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFyZXF1ZXN0SWQpIHtcbiAgICAgICAgICAgIGNoaWxkTG9nZ2VyLndhcm4oJ05vIHgtcmVxdWVzdC1pZCBmb3VuZCBpbiBtZXNzYWdlIGF0dHJpYnV0ZXMnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IHN0YXR1c0NvZGU6IDIwMCwgYm9keTogYFByb2Nlc3NlZCAke2V2ZW50LlJlY29yZHMubGVuZ3RofSByZWNvcmRzYCB9O1xufSk7XG4iXX0=