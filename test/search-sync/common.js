"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.sleep = exports.createRequester = exports.getApiUrl = exports.REGION = exports.STACK_NAME = void 0;
const client_cloudformation_1 = require("@aws-sdk/client-cloudformation");
exports.STACK_NAME = 'vitkuz-testing-search-sync';
exports.REGION = process.env.AWS_REGION || 'us-east-1';
const getApiUrl = async () => {
    console.log(`ðŸ” Discovering API URL for stack: ${exports.STACK_NAME}...`);
    const cf = new client_cloudformation_1.CloudFormationClient({ region: exports.REGION });
    const stacksCmd = new client_cloudformation_1.DescribeStacksCommand({ StackName: exports.STACK_NAME });
    const stacksResp = await cf.send(stacksCmd);
    const apiUrlOutput = stacksResp.Stacks?.[0].Outputs?.find((o) => o.OutputKey === 'ApiUrl');
    if (!apiUrlOutput?.OutputValue) {
        throw new Error('Could not find ApiUrl output in stack');
    }
    const apiUrl = apiUrlOutput.OutputValue;
    console.log(`  API URL: ${apiUrl}`);
    return apiUrl;
};
exports.getApiUrl = getApiUrl;
const createRequester = (apiUrl, requestId) => {
    return async (method, path, body) => {
        const res = await fetch(`${apiUrl}${path}`, {
            method,
            headers: {
                'Content-Type': 'application/json',
                'x-request-id': requestId,
            },
            body: body ? JSON.stringify(body) : undefined,
        });
        if (!res.ok) {
            const text = await res.text();
            throw new Error(`${method} ${path} failed: ${res.status} ${text}`);
        }
        return res.json();
    };
};
exports.createRequester = createRequester;
const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
exports.sleep = sleep;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29tbW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDBFQUE2RjtBQUVoRixRQUFBLFVBQVUsR0FBRyw0QkFBNEIsQ0FBQztBQUMxQyxRQUFBLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxXQUFXLENBQUM7QUFFckQsTUFBTSxTQUFTLEdBQUcsS0FBSyxJQUFxQixFQUFFO0lBQ2pELE9BQU8sQ0FBQyxHQUFHLENBQUMscUNBQXFDLGtCQUFVLEtBQUssQ0FBQyxDQUFDO0lBQ2xFLE1BQU0sRUFBRSxHQUFHLElBQUksNENBQW9CLENBQUMsRUFBRSxNQUFNLEVBQUUsY0FBTSxFQUFFLENBQUMsQ0FBQztJQUN4RCxNQUFNLFNBQVMsR0FBRyxJQUFJLDZDQUFxQixDQUFDLEVBQUUsU0FBUyxFQUFFLGtCQUFVLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZFLE1BQU0sVUFBVSxHQUFHLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM1QyxNQUFNLFlBQVksR0FBRyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsS0FBSyxRQUFRLENBQUMsQ0FBQztJQUUzRixJQUFJLENBQUMsWUFBWSxFQUFFLFdBQVcsRUFBRSxDQUFDO1FBQzdCLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBQ0QsTUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQztJQUN4QyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUNwQyxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDLENBQUM7QUFiVyxRQUFBLFNBQVMsYUFhcEI7QUFFSyxNQUFNLGVBQWUsR0FBRyxDQUFDLE1BQWMsRUFBRSxTQUFpQixFQUFFLEVBQUU7SUFDakUsT0FBTyxLQUFLLEVBQUUsTUFBYyxFQUFFLElBQVksRUFBRSxJQUFVLEVBQUUsRUFBRTtRQUN0RCxNQUFNLEdBQUcsR0FBRyxNQUFNLEtBQUssQ0FBQyxHQUFHLE1BQU0sR0FBRyxJQUFJLEVBQUUsRUFBRTtZQUN4QyxNQUFNO1lBQ04sT0FBTyxFQUFFO2dCQUNMLGNBQWMsRUFBRSxrQkFBa0I7Z0JBQ2xDLGNBQWMsRUFBRSxTQUFTO2FBQzVCO1lBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUztTQUNoRCxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ1YsTUFBTSxJQUFJLEdBQUcsTUFBTSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDOUIsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLE1BQU0sSUFBSSxJQUFJLFlBQVksR0FBRyxDQUFDLE1BQU0sSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZFLENBQUM7UUFDRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN0QixDQUFDLENBQUM7QUFDTixDQUFDLENBQUM7QUFoQlcsUUFBQSxlQUFlLG1CQWdCMUI7QUFFSyxNQUFNLEtBQUssR0FBRyxDQUFDLEVBQVUsRUFBRSxFQUFFLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUE5RCxRQUFBLEtBQUssU0FBeUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDbG91ZEZvcm1hdGlvbkNsaWVudCwgRGVzY3JpYmVTdGFja3NDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uJztcblxuZXhwb3J0IGNvbnN0IFNUQUNLX05BTUUgPSAndml0a3V6LXRlc3Rpbmctc2VhcmNoLXN5bmMnO1xuZXhwb3J0IGNvbnN0IFJFR0lPTiA9IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ3VzLWVhc3QtMSc7XG5cbmV4cG9ydCBjb25zdCBnZXRBcGlVcmwgPSBhc3luYyAoKTogUHJvbWlzZTxzdHJpbmc+ID0+IHtcbiAgICBjb25zb2xlLmxvZyhg8J+UjSBEaXNjb3ZlcmluZyBBUEkgVVJMIGZvciBzdGFjazogJHtTVEFDS19OQU1FfS4uLmApO1xuICAgIGNvbnN0IGNmID0gbmV3IENsb3VkRm9ybWF0aW9uQ2xpZW50KHsgcmVnaW9uOiBSRUdJT04gfSk7XG4gICAgY29uc3Qgc3RhY2tzQ21kID0gbmV3IERlc2NyaWJlU3RhY2tzQ29tbWFuZCh7IFN0YWNrTmFtZTogU1RBQ0tfTkFNRSB9KTtcbiAgICBjb25zdCBzdGFja3NSZXNwID0gYXdhaXQgY2Yuc2VuZChzdGFja3NDbWQpO1xuICAgIGNvbnN0IGFwaVVybE91dHB1dCA9IHN0YWNrc1Jlc3AuU3RhY2tzPy5bMF0uT3V0cHV0cz8uZmluZCgobykgPT4gby5PdXRwdXRLZXkgPT09ICdBcGlVcmwnKTtcblxuICAgIGlmICghYXBpVXJsT3V0cHV0Py5PdXRwdXRWYWx1ZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIEFwaVVybCBvdXRwdXQgaW4gc3RhY2snKTtcbiAgICB9XG4gICAgY29uc3QgYXBpVXJsID0gYXBpVXJsT3V0cHV0Lk91dHB1dFZhbHVlO1xuICAgIGNvbnNvbGUubG9nKGAgIEFQSSBVUkw6ICR7YXBpVXJsfWApO1xuICAgIHJldHVybiBhcGlVcmw7XG59O1xuXG5leHBvcnQgY29uc3QgY3JlYXRlUmVxdWVzdGVyID0gKGFwaVVybDogc3RyaW5nLCByZXF1ZXN0SWQ6IHN0cmluZykgPT4ge1xuICAgIHJldHVybiBhc3luYyAobWV0aG9kOiBzdHJpbmcsIHBhdGg6IHN0cmluZywgYm9keT86IGFueSkgPT4ge1xuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChgJHthcGlVcmx9JHtwYXRofWAsIHtcbiAgICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgICAgICd4LXJlcXVlc3QtaWQnOiByZXF1ZXN0SWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYm9keTogYm9keSA/IEpTT04uc3RyaW5naWZ5KGJvZHkpIDogdW5kZWZpbmVkLFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFyZXMub2spIHtcbiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBhd2FpdCByZXMudGV4dCgpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke21ldGhvZH0gJHtwYXRofSBmYWlsZWQ6ICR7cmVzLnN0YXR1c30gJHt0ZXh0fWApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXMuanNvbigpO1xuICAgIH07XG59O1xuXG5leHBvcnQgY29uc3Qgc2xlZXAgPSAobXM6IG51bWJlcikgPT4gbmV3IFByb21pc2UoKHIpID0+IHNldFRpbWVvdXQociwgbXMpKTtcbiJdfQ==